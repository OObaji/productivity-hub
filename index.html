<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyndArc - Your Productivity Hub</title>
    
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="MyndArc - Your Productivity Hub">
    <meta property="og:description" content="Master your time with the Pomodoro Timer, Shift Tracker, and Productivity Tools. Organize your life and achieve more with MyndArc.">
    <meta property="og:image" content="https://images.unsplash.com/photo-1484417894907-623942c8ee29?q=80&w=1200&auto=format&fit=crop">
    <meta property="og:url" content=""> 

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="MyndArc - Your Productivity Hub">
    <meta property="twitter:description" content="Master your time with the Pomodoro Timer, Shift Tracker, and Productivity Tools. Organize your life and achieve more with MyndArc.">
    <meta property="twitter:image" content="https://images.unsplash.com/photo-1484417894907-623942c8ee29?q=80&w=1200&auto=format&fit=crop">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/96/brain.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Added QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; scroll-behavior: smooth; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Utility */
        .chart-container { position: relative; width: 100%; max-width: 900px; margin: 0 auto; height: 220px; max-height: 250px; }
        @media (min-width: 768px) { .chart-container { height: 250px; } }
        
        /* Custom Checkbox Styling */
        .task-checkbox:checked + label span:first-child { background-color: #6366f1; border-color: #6366f1; }
        .task-checkbox:checked + label span:first-child svg { display: block; }
        .task-checkbox:checked + label { text-decoration: line-through; color: #9ca3af; }
        
        /* Landing Page Transitions */
        .landing-page { position: relative; background-color: #f8fafc; transition: opacity 0.5s ease-out, visibility 0.5s ease-out; }
        #landing-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        
        /* Fade Utilities */
        .hidden-fade { opacity: 0; visibility: hidden; display: none; }
        .visible-fade { opacity: 1; visibility: visible; display: flex; }
        
        /* View Management */
        .page-view { display: none; animation: fadeIn 0.3s ease-out; }
        .page-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Sidebar Styling */
        .sidebar-link { transition: all 0.2s ease; border-left: 3px solid transparent; }
        .sidebar-link:hover { background-color: rgba(255,255,255,0.05); }
        .sidebar-link.active { background: linear-gradient(90deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%); border-left-color: #6366f1; color: #818cf8; }
        .sidebar-topics-submenu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        
        /* Immersive Views */
        #pomodoro.page-view, #shift-timer.page-view, #idea-board.page-view, #mindfulness.page-view {
            background-size: cover; background-position: center; transition: background-color 0.5s ease-in-out, background-image 0.5s ease-in-out;
        }
        .overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        
        /* Pomodoro Specifics */
        #pomodoro-timer-container { width: 320px; height: 320px; position: relative; }
        #pomodoro-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #pomodoro-controls { position: relative; z-index: 10; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        
        /* Shift Timer Specifics */
        #shift-timer-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        
        /* Idea Board */
        #idea-board { background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; background-color: #f3f4f6; }
        .dark #idea-board { background-image: radial-gradient(#374151 1px, transparent 1px); background-color: #1f2937; }
        .sticky-note { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transition: transform .15s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.15s; cursor: grab; resize: both; overflow: hidden; border-radius: 0.5rem; }
        .sticky-note:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .sticky-note.dragging { transform: scale(1.05) rotate(2deg); z-index: 50; cursor: grabbing; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        
        /* Mindfulness */
        #mindfulness { background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .dark #mindfulness { background-image: linear-gradient(to top, #0f172a 0%, #312e81 100%); }
        #breathing-visualizer { width: 220px; height: 220px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 0 30px rgba(255,255,255,0.1); transition: transform 4s ease-in-out; position: relative; }
        #breathing-visualizer.breathing { animation: breathe 10s ease-in-out infinite; }
        @keyframes breathe { 0% { transform: scale(1); box-shadow: 0 0 30px rgba(255,255,255,0.1); } 40% { transform: scale(1.4); box-shadow: 0 0 60px rgba(255,255,255,0.3); } 60% { transform: scale(1.4); box-shadow: 0 0 60px rgba(255,255,255,0.3); } 100% { transform: scale(1); box-shadow: 0 0 30px rgba(255,255,255,0.1); } }

        /* Game */
        #ball-game-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 1rem; box-sizing: border-box; background-color: #0f172a; }
        #game-canvas { background-color: #1e293b; border: 2px solid #334155; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        #game-controls { display: flex; gap: 1rem; margin-top: 1.5rem; }
        #game-info { display: flex; justify-content: space-between; width: 100%; max-width: 500px; color: #f8fafc; font-family: 'Inter', sans-serif; font-size: 1.25rem; margin-bottom: 1rem; font-weight: 600; }
        
        /* Glass Panel */
        .glass-panel { background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .neon-text { color: #fff; text-shadow: 0 0 5px rgba(255, 255, 255, 0.5), 0 0 10px rgba(45, 212, 191, 0.3), 0 0 15px rgba(45, 212, 191, 0.2); }
        .vibe-card { transition: all 0.3s ease; border-left: 4px solid transparent; }
        .vibe-card.active { background: rgba(13, 148, 136, 0.15); border-left-color: #2dd4bf; }
        
        @keyframes vibePan { 0% { background-position: 0% 50%; background-size: 120% auto; } 50% { background-position: 100% 50%; background-size: 130% auto; } 100% { background-position: 0% 50%; background-size: 120% auto; } }
        .vibe-animated { animation: vibePan 60s ease-in-out infinite alternate !important; }
        @keyframes iconFloat { 0%, 100% { transform: translateY(0) scale(1); filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); } 50% { transform: translateY(-6px) scale(1.1); filter: drop-shadow(0 0 15px rgba(45, 212, 191, 0.6)); } }
        .icon-float { animation: iconFloat 4s ease-in-out infinite; display: inline-block; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 selection:bg-indigo-500 selection:text-white">

    <!-- Generic Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden items-center justify-center p-4 transition-all">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center border border-gray-100 dark:border-gray-700 transform scale-100">
            <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">‚ÑπÔ∏è</div>
            <p id="alert-message" class="text-lg font-medium text-slate-800 dark:text-slate-200 mb-8"></p>
            <button id="alert-close-btn" class="w-full px-6 py-3.5 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/30 transition-all hover:scale-[1.02]">Got it</button>
        </div>
    </div>

    <!-- Principle Details Modal -->
    <div id="principle-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-8 w-full max-w-lg text-left relative transform scale-95 transition-transform duration-300 border border-gray-100 dark:border-gray-700">
            <button id="principle-modal-close-btn" class="absolute top-6 right-6 text-gray-400 hover:text-gray-800 dark:hover:text-white transition-colors bg-gray-100 dark:bg-gray-700 rounded-full p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 id="principle-modal-title" class="text-3xl font-extrabold text-slate-900 dark:text-white mb-3 tracking-tight"></h2>
            <p id="principle-modal-description" class="text-slate-600 dark:text-slate-400 mb-6 text-lg leading-relaxed"></p>
            <div id="principle-modal-tasks" class="max-h-64 overflow-y-auto pr-2 custom-scrollbar space-y-4"></div>
            <button id="principle-modal-ok-btn" class="mt-8 w-full px-6 py-3.5 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/30 transition-all hover:scale-[1.02]">Close</button>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="fixed inset-0 bg-black/80 z-[60] hidden items-center justify-center p-4 backdrop-blur-md transition-all">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center transform transition-all scale-100 flex flex-col items-center border border-white/10">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Scan to Sync</h3>
            <p class="text-slate-500 dark:text-slate-400 mb-6 text-sm">Point your phone camera here to open this shift.</p>
            
            <div class="bg-white p-4 rounded-2xl shadow-inner mb-6 border border-gray-100">
                <div id="qrcode-container"></div>
            </div>
            
            <div class="flex w-full gap-3">
                <button id="copy-link-fallback-btn" class="flex-1 py-3 px-4 bg-indigo-500/10 text-indigo-600 dark:text-indigo-400 font-bold rounded-xl hover:bg-indigo-500/20 transition-colors flex items-center justify-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                    Copy Link
                </button>
                <button id="close-qr-btn" class="flex-1 py-3 px-4 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Overtime Edit Modal -->
    <div id="overtime-edit-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-8 w-full max-w-md space-y-5 border border-gray-100 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Edit Entry</h2>
            <input type="hidden" id="edit-overtime-id">
            <div>
                <label for="edit-overtime-date" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">Date</label>
                <input type="date" id="edit-overtime-date" class="w-full px-4 py-2.5 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all">
            </div>
            <div>
                <label for="edit-overtime-hours" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">Hours Completed</label>
                <input type="number" id="edit-overtime-hours" class="w-full px-4 py-2.5 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all">
            </div>
             <div>
                <label for="edit-overtime-rate" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">Rate per Hour (¬£)</label>
                <input type="number" id="edit-overtime-rate" class="w-full px-4 py-2.5 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all">
            </div>
            <div>
                <label for="edit-overtime-allocation" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5">Allocation</label>
                <select id="edit-overtime-allocation" class="w-full px-4 py-2.5 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all">
                    <option>Savings</option>
                    <option>Holiday</option>
                    <option value="Other">Other (Specify)</option>
                </select>
                <input type="text" id="edit-overtime-allocation-custom" class="mt-3 hidden w-full px-4 py-2.5 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all" placeholder="Custom allocation name">
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button id="cancel-edit-overtime-btn" class="px-5 py-2.5 bg-gray-100 dark:bg-gray-700 text-slate-700 dark:text-slate-300 font-bold rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Cancel</button>
                <button id="save-edit-overtime-btn" class="px-5 py-2.5 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition-all hover:scale-[1.02]">Save Changes</button>
            </div>
        </div>
    </div>

    <section id="landing-page" class="landing-page h-screen w-full flex items-center justify-center text-center p-4">
        <canvas id="landing-canvas"></canvas>
        <div class="relative z-10 max-w-3xl">
            <h1 class="text-6xl md:text-8xl font-extrabold text-slate-900 tracking-tight mb-6">Find Your <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">Focus.</span></h1>
            <p class="mt-4 text-xl text-slate-600 max-w-2xl mx-auto leading-relaxed">A unified hub for your tasks, goals, and learning. Organize your life and achieve more, one day at a time.</p>
            <button id="get-started-btn" class="mt-10 px-10 py-4 bg-slate-900 text-white font-bold text-lg rounded-full shadow-2xl hover:bg-indigo-600 hover:shadow-indigo-500/30 focus:outline-none focus:ring-4 focus:ring-indigo-500/30 transform hover:scale-105 transition-all duration-300">
                Enter Hub
            </button>
        </div>
    </section>

    <div id="app-layout" class="hidden-fade h-screen flex">
        <!-- Sidebar -->
        <nav id="sidebar" class="w-72 bg-slate-900 text-slate-300 flex-shrink-0 flex flex-col h-full p-5 fixed lg:relative z-30 -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out border-r border-slate-800">
            <div class="flex items-center justify-between mb-10 px-2">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    </div>
                    <span class="font-bold text-lg text-white tracking-tight">MyndArc</span>
                </div>
                <button id="close-sidebar-btn" class="lg:hidden text-slate-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div id="user-info-container" class="text-xs text-center mb-6 p-3 rounded-xl bg-slate-800/50 border border-slate-700 overflow-hidden text-ellipsis whitespace-nowrap hidden">
                <span class="text-slate-400">ID:</span>
                <span id="user-id-display" class="font-mono text-indigo-400 font-bold ml-1"></span>
            </div>

            <div class="flex-grow overflow-y-auto space-y-1 custom-scrollbar pr-2">
                <p class="px-3 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-2">Main</p>
                
                <a href="#" class="sidebar-link nav-link flex items-center p-3 rounded-xl hover:bg-slate-800/50 active text-sm font-medium" data-view="dashboard-home">
                    <svg class="w-5 h-5 mr-3 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                    Dashboard
                </a>
                
                <div class="space-y-1">
                    <button id="topics-toggle-btn" class="sidebar-link w-full flex items-center p-3 rounded-xl hover:bg-slate-800/50 text-sm font-medium text-left">
                        <svg class="w-5 h-5 mr-3 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                        <span class="flex-grow">Principles</span>
                        <svg id="topics-arrow" class="w-4 h-4 transform transition-transform opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="topics-submenu" class="sidebar-topics-submenu pl-11 space-y-1">
                        <a href="#" class="block text-xs p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white topic-filter transition-colors" data-module="all">All Principles</a>
                        <a href="#" class="block text-xs p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white topic-filter transition-colors" data-module="Ikigai (Áîü„ÅçÁî≤Êñê)">Ikigai</a>
                        <a href="#" class="block text-xs p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white topic-filter transition-colors" data-module="Eisenhower Matrix">Eisenhower</a>
                        <a href="#" class="block text-xs p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white topic-filter transition-colors" data-module="Pareto Principle (80/20)">Pareto (80/20)</a>
                    </div>
                </div>

                <p class="px-3 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-6">Focus Zones</p>

                <a href="#" class="sidebar-link nav-link flex items-center p-3 rounded-xl hover:bg-slate-800/50 text-sm font-medium" data-view="pomodoro">
                    <svg class="w-5 h-5 mr-3 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Pomodoro
                </a>
                <a href="#" class="sidebar-link nav-link flex items-center p-3 rounded-xl hover:bg-slate-800/50 text-sm font-medium" data-view="mindfulness">
                    <svg class="w-5 h-5 mr-3 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Meditation
                </a>
                <a href="#" class="sidebar-link nav-link flex items-center p-3 rounded-xl hover:bg-slate-800/50 text-sm font-medium" data-view="shift-timer">
                    <svg class="w-5 h-5 mr-3 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Shift Timer
                </a>
                <a href="#" class="sidebar-link nav-link flex items-center p-3 rounded-xl hover:bg-slate-800/50 text-sm font-medium" data-view="breach-list">
                    <svg class="w-5 h-5 mr-3 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    Breach List
                </a>

                <div class="space-y-1">
                    <button id="tools-toggle-btn" class="sidebar-link w-full flex items-center p-3 rounded-xl hover:bg-slate-800/50 text-sm font-medium text-left">
                        <svg class="w-5 h-5 mr-3 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="flex-grow">Tools</span>
                        <svg id="tools-arrow" class="w-4 h-4 transform transition-transform opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="tools-submenu" class="sidebar-topics-submenu pl-11 space-y-1">
                        <a href="#" class="nav-link block text-xs p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white transition-colors" data-view="hour-calculator">Hour Calc</a>
                        <a href="#" class="nav-link block text-xs p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white transition-colors" data-view="idea-board">Idea Board</a>
                        <a href="#" class="nav-link block text-xs p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white transition-colors" data-view="salary-calculator">Salary Calc</a>
                        <a href="#" class="nav-link block text-xs p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white transition-colors" data-view="overtime-tracker">Overtime</a>
                        <a href="#" class="nav-link block text-xs p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white transition-colors" data-view="ball-game">Break Game</a>
                    </div>
                </div>

                <!-- Focus Sounds Player -->
                <div class="mt-8 p-4 bg-slate-800/60 rounded-2xl border border-slate-700/50 backdrop-blur-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
                            Soundscapes
                        </h3>
                        <span id="sound-status-indicator" class="w-2 h-2 rounded-full bg-slate-600 transition-all duration-300"></span>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-2 mb-4">
                        <!-- Re-organized grid for better layout -->
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-indigo-600 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-indigo-400/30 hover:shadow-lg hover:shadow-indigo-500/20 group" data-type="brown" title="Brown Noise">üåä</button>
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-emerald-600 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-emerald-400/30 hover:shadow-lg hover:shadow-emerald-500/20 group" data-type="green" title="Green Noise">üåø</button>
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-pink-500 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-pink-400/30 hover:shadow-lg hover:shadow-pink-500/20 group" data-type="pink" title="Pink Noise">üåßÔ∏è</button>
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-slate-500 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-slate-400/30 hover:shadow-lg hover:shadow-slate-500/20 group" data-type="white" title="White Noise">üí®</button>
                        
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-blue-500 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-blue-400/30 hover:shadow-lg hover:shadow-blue-500/20 group" data-type="rain" title="Rain">‚òî</button>
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-cyan-500 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-cyan-400/30 hover:shadow-lg hover:shadow-cyan-500/20 group" data-type="waves" title="Waves">üèñÔ∏è</button>
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-orange-500 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-orange-400/30 hover:shadow-lg hover:shadow-orange-500/20 group" data-type="city" title="City">üèôÔ∏è</button>
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-amber-600 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-amber-400/30 hover:shadow-lg hover:shadow-amber-500/20 group" data-type="cafe" title="Cafe">‚òï</button>
                        
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-indigo-500 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-indigo-400/30 hover:shadow-lg hover:shadow-indigo-500/20 group" data-type="lofi" title="Lofi">üéß</button>
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-teal-500 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-teal-400/30 hover:shadow-lg hover:shadow-teal-500/20 group" data-type="forest" title="Forest">üå≤</button>
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-red-500 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-red-400/30 hover:shadow-lg hover:shadow-red-500/20 group" data-type="fire" title="Fire">üî•</button>
                        <button class="sound-btn aspect-square rounded-xl bg-slate-700/50 hover:bg-purple-600 hover:text-white text-slate-400 transition-all flex items-center justify-center text-lg border border-transparent hover:border-purple-400/30 hover:shadow-lg hover:shadow-purple-500/20 group" data-type="gamma" title="Gamma 40Hz">üß†</button>
                    </div>

                    <div class="flex items-center gap-3 px-1">
                        <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                        <input type="range" id="sound-volume" min="0" max="1" step="0.01" value="0.3" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-500 accent-indigo-500">
                    </div>
                </div>
            </div>
            
            <div class="border-t border-slate-800 pt-6 mt-4">
                 <a href="#" class="sidebar-link nav-link flex items-center p-3 rounded-xl hover:bg-slate-800/50 text-sm font-medium text-slate-400 hover:text-white transition-colors" data-view="settings">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Settings
                </a>
                 <a href="#" id="logout-btn" class="sidebar-link flex items-center p-3 mt-1 rounded-xl hover:bg-slate-800/50 text-sm font-medium text-slate-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    Log Out
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="main-container" class="flex-1 h-full overflow-y-auto bg-slate-50 dark:bg-slate-900 relative">
             <header class="p-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md shadow-sm lg:hidden flex justify-between items-center sticky top-0 z-20">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    </div>
                    <span class="font-bold text-lg text-slate-800 dark:text-white">MyndArc</span>
                </div>
                <button id="open-sidebar-btn" class="p-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </header>
            
            <div id="main-content-wrapper" class="h-full">
                <!-- Dashboard Home -->
                <div id="dashboard-home" class="page-view active container mx-auto px-6 py-10 max-w-7xl">
                    
                    <!-- Hero Section -->
                    <section id="time-weather-section" class="mb-10 p-8 md:p-10 rounded-[2rem] shadow-xl flex flex-col md:flex-row justify-between items-center text-white relative overflow-hidden bg-gradient-to-r from-indigo-600 to-purple-600">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                        <div class="relative z-10 text-center md:text-left">
                            <p id="date-display" class="text-indigo-100 font-medium text-lg uppercase tracking-wide mb-1">Loading Date...</p>
                            <p id="time-display" class="text-5xl md:text-7xl font-bold tracking-tight font-mono">--:--</p>
                        </div>
                        <div id="weather-display" class="relative z-10 text-center md:text-right mt-6 md:mt-0 flex items-center gap-6 bg-white/10 backdrop-blur-sm p-4 rounded-2xl border border-white/10">
                            <!-- Weather data will be injected here -->
                        </div>
                    </section>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                        <!-- Daily Quote Card -->
                        <section id="daily-quote-section" class="lg:col-span-2 p-8 bg-white dark:bg-slate-800 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col justify-center relative overflow-hidden group hover:shadow-md transition-shadow duration-300">
                            <div class="absolute top-0 left-0 w-2 h-full bg-yellow-400"></div>
                            <svg class="absolute top-4 right-6 w-16 h-16 text-slate-100 dark:text-slate-700 transform rotate-12" fill="currentColor" viewBox="0 0 24 24"><path d="M14.017 21L14.017 18C14.017 16.8954 14.9124 16 16.017 16H19.017C19.5693 16 20.017 15.5523 20.017 15V9C20.017 8.44772 19.5693 8 19.017 8H15.017C14.4647 8 14.017 8.44772 14.017 9V11C14.017 11.5523 13.5693 12 13.017 12H12.017V5H22.017V15C22.017 18.3137 19.3307 21 16.017 21H14.017ZM5.01691 21L5.01691 18C5.01691 16.8954 5.91234 16 7.01691 16H10.0169C10.5692 16 11.0169 15.5523 11.0169 15V9C11.0169 8.44772 10.5692 8 10.0169 8H6.01691C5.46462 8 5.01691 8.44772 5.01691 9V11C5.01691 11.5523 4.56919 12 4.01691 12H3.01691V5H13.0169V15C13.0169 18.3137 10.3306 21 7.01691 21H5.01691Z"></path></svg>
                            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Daily Inspiration</h2>
                            <blockquote class="relative z-10">
                                <p id="quote-text" class="text-2xl md:text-3xl font-serif text-slate-800 dark:text-slate-100 leading-snug">"The secret of getting ahead is getting started."</p>
                                <cite id="quote-author" class="block mt-4 not-italic font-semibold text-indigo-600 dark:text-indigo-400 text-lg">‚Äî Mark Twain</cite>
                            </blockquote>
                        </section>

                        <!-- Breach Summary Mini Card -->
                        <section id="breach-stats-card" class="p-8 bg-white dark:bg-slate-800 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col justify-between hover:shadow-md transition-shadow duration-300">
                            <div class="flex justify-between items-start mb-4">
                                <h2 class="text-lg font-bold text-slate-800 dark:text-white">Breach List</h2>
                                <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">Today</span>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="flex justify-between items-end">
                                    <div>
                                        <span id="breach-stats-completed" class="text-4xl font-bold text-slate-800 dark:text-white">0</span>
                                        <span class="text-slate-400 text-sm ml-1">/ <span id="breach-stats-total">0</span></span>
                                    </div>
                                    <div class="text-right">
                                        <div id="breach-stats-progress-percent" class="text-indigo-600 dark:text-indigo-400 font-bold text-xl">0%</div>
                                        <div class="text-xs text-slate-400">Complete</div>
                                    </div>
                                </div>
                                <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-3 overflow-hidden">
                                    <div id="breach-stats-progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-3 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div id="breach-log-container" class="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700 max-h-[120px] overflow-y-auto custom-scrollbar">
                                <!-- Minimal log list injected here -->
                            </div>
                        </section>
                    </div>

                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-6 px-2">Core Curriculum</h2>
                    <main id="curriculum-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                        <!-- Module Cards injected here -->
                    </main>
                </div>

                <!-- Pomodoro View -->
                <div id="pomodoro" class="page-view h-full">
                    <div class="overlay flex flex-col items-center justify-center h-full p-6 text-white bg-black/40">
                        <div class="w-full max-w-lg bg-white/10 backdrop-blur-xl p-8 rounded-[2rem] border border-white/10 shadow-2xl mb-8 transform hover:scale-[1.01] transition-transform duration-300">
                            <label for="focus-task-input" class="text-xs font-bold uppercase tracking-widest text-white/60 mb-2 block">Current Objective</label>
                            <input id="focus-task-input" type="text" placeholder="What are you working on?" class="w-full bg-transparent border-b-2 border-white/20 focus:border-white focus:outline-none py-3 text-2xl font-medium placeholder-white/30 transition-colors">
                        </div>
                        
                        <div id="pomodoro-timer-container" class="bg-white/5 backdrop-blur-md rounded-full p-8 flex flex-col items-center justify-between shadow-2xl border border-white/10 relative mb-8">
                            <div class="relative flex items-center justify-center w-full h-full">
                                <canvas id="pomodoro-canvas" class="absolute top-0 left-0" width="270" height="270"></canvas>
                                <div id="pomodoro-controls" class="absolute flex flex-col items-center z-20">
                                    <span id="pomodoro-icon" class="text-5xl mb-2 filter drop-shadow-lg">üçÖ</span>
                                    <div id="pomodoro-time" class="text-7xl font-mono font-bold my-1 tracking-tighter drop-shadow-md">25:00</div>
                                    <div id="pomodoro-mode" class="text-sm font-bold tracking-[0.2em] uppercase text-white/80">Focus</div>
                                    <button id="pomodoro-play-pause" class="mt-6 bg-white text-indigo-900 rounded-full p-4 hover:bg-indigo-50 hover:scale-110 transition-all shadow-lg group">
                                        <svg id="play-icon" class="w-8 h-8 ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M4.018 15.59a.5.5 0 00.816.372l10-7a.5.5 0 000-.744l-10-7A.5.5 0 004 2v13.59z" /></svg>
                                        <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75A.75.75 0 007.25 3h-1.5zM12.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75h-1.5z" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-6">
                            <button id="pomodoro-switch-mode" class="px-8 py-3 bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-xl font-bold uppercase tracking-wider text-sm border border-white/10 transition-all">Skip Phase</button>
                            <div class="text-center bg-white/10 px-6 py-2 rounded-xl backdrop-blur-md border border-white/10">
                                <div id="pomodoro-session-count" class="text-2xl font-bold">0</div>
                                <div class="text-[10px] uppercase font-bold tracking-widest text-white/60">Sessions</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mindfulness View -->
                <div id="mindfulness" class="page-view h-full relative overflow-hidden">
                    <div class="absolute inset-0 bg-black/20 pointer-events-none"></div>
                    <!-- Navigation Tabs -->
                    <div class="absolute top-8 left-0 w-full flex justify-center z-20">
                         <div class="bg-black/30 backdrop-blur-xl p-1.5 rounded-full flex border border-white/10 shadow-lg">
                             <button id="tab-breathing" class="px-8 py-2.5 rounded-full text-white font-bold bg-white/20 shadow-sm transition-all text-sm tracking-wide">Breathing</button>
                             <button id="tab-refresh" class="px-8 py-2.5 rounded-full text-white/60 hover:text-white font-bold transition-all text-sm tracking-wide">Quick Refresh</button>
                         </div>
                    </div>

                    <!-- Breathing View -->
                    <div id="view-breathing" class="absolute inset-0 flex flex-col items-center justify-center p-4 text-white text-center transition-all duration-500 z-10">
                        <h1 class="text-5xl md:text-6xl font-extrabold mb-4 tracking-tight drop-shadow-md">Inhale. Exhale.</h1>
                        <p class="mb-12 max-w-md text-lg text-white/80 font-medium">Follow the rhythm to center your mind.</p>

                        <div id="breathing-visualizer" class="flex items-center justify-center mb-12">
                            <span id="breathing-instruction" class="text-3xl font-bold text-white tracking-wide transition-opacity duration-500 drop-shadow-lg">Ready?</span>
                        </div>

                        <div id="mindfulness-controls" class="w-full max-w-sm bg-white/10 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border border-white/20">
                            <div class="flex items-center justify-between mb-6">
                                <label for="mindfulness-duration" class="font-bold text-sm uppercase tracking-wider text-white/80">Duration</label>
                                <select id="mindfulness-duration" class="bg-white/20 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-white/50 text-white font-bold cursor-pointer border border-white/10">
                                    <option value="60" class="text-slate-900">1 Minute</option>
                                    <option value="180" class="text-slate-900">3 Minutes</option>
                                    <option value="300" class="text-slate-900">5 Minutes</option>
                                </select>
                            </div>
                            <button id="mindfulness-start-btn" class="w-full px-8 py-4 bg-white text-indigo-900 font-bold text-lg rounded-2xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">
                                Start Session
                            </button>
                        </div>

                        <div class="mt-8 text-center opacity-60 hover:opacity-100 transition-opacity">
                            <div id="mindfulness-session-count" class="text-3xl font-bold">0</div>
                            <div class="text-xs font-bold uppercase tracking-widest">Sessions Completed</div>
                        </div>
                    </div>

                    <!-- Refresh View -->
                    <div id="view-refresh" class="absolute inset-0 flex flex-col items-center justify-center p-4 text-white text-center transition-all duration-500 opacity-0 pointer-events-none transform translate-y-4 z-10">
                         <div id="refresh-circle" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-1000">
                             <div class="w-[600px] h-[600px] bg-white/5 rounded-full blur-[100px] animate-pulse"></div>
                         </div>
                         
                         <div class="relative z-10 max-w-2xl px-4">
                             <h2 id="refresh-text" class="text-4xl md:text-6xl font-bold mb-16 leading-tight drop-shadow-lg transition-all duration-700 min-h-[160px] flex items-center justify-center">
                                 Need a mental reset?
                             </h2>
                             
                             <div id="refresh-controls" class="transition-opacity duration-500">
                                 <button id="start-refresh-btn" class="px-12 py-5 bg-white text-indigo-900 font-bold rounded-full shadow-[0_0_30px_rgba(255,255,255,0.2)] hover:shadow-[0_0_50px_rgba(255,255,255,0.4)] hover:scale-105 transition-all text-xl">
                                     Start Refresh (1 min)
                                 </button>
                                 <p class="mt-6 text-white/50 text-sm font-medium tracking-wide">A guided sequence to reset your focus.</p>
                             </div>
                         </div>
                    </div>
                </div>

                <!-- Shift Timer View -->
                <div id="shift-timer" class="page-view h-full relative bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-900 via-slate-900 to-black">
                    <canvas id="shift-timer-canvas" class="absolute top-0 left-0 w-full h-full opacity-60"></canvas>
                    <div class="relative z-10 w-full h-full overflow-y-auto overflow-x-hidden p-4 md:p-8 flex flex-col items-center">
                        <!-- SETUP VIEW -->
                        <div id="shift-setup" class="w-full max-w-lg glass-panel p-10 rounded-[2.5rem] shadow-2xl mx-auto my-auto border border-white/10 backdrop-blur-xl">
                            <h2 class="text-4xl font-extrabold mb-8 text-center text-transparent bg-clip-text bg-gradient-to-r from-teal-300 to-emerald-300 neon-text tracking-tight">Shift Setup</h2>
                            <!-- Location Toggle -->
                            <div class="flex justify-center mb-8">
                                <div class="bg-black/40 p-1.5 rounded-2xl flex border border-white/10 shadow-inner">
                                    <button id="loc-home-btn" class="px-8 py-3 rounded-xl text-sm font-bold transition-all flex items-center gap-2 bg-teal-500/20 text-teal-300 border border-teal-500/50 shadow-[0_0_15px_rgba(45,212,191,0.15)]"><span>üè†</span> Home</button>
                                    <button id="loc-office-btn" class="px-8 py-3 rounded-xl text-sm font-bold transition-all flex items-center gap-2 text-gray-400 hover:text-white border border-transparent"><span>üè¢</span> Office</button>
                                </div>
                            </div>
                             <div class="space-y-6">
                                <div class="text-left">
                                    <label class="block text-xs font-bold text-teal-200 uppercase tracking-widest mb-2 ml-1">Shift Name</label>
                                    <input type="text" id="shift-title-input" placeholder="e.g., Night Shift Grind" value="Let's get this bread!" class="w-full p-4 rounded-2xl bg-black/40 text-white border border-white/10 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/50 transition-all text-lg placeholder-gray-500 font-medium">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="text-left">
                                        <label for="shift-start-time-input" class="block text-xs font-bold text-teal-200 uppercase tracking-widest mb-2 ml-1">Start Time</label>
                                        <input type="datetime-local" id="shift-start-time-input" class="w-full p-4 rounded-2xl bg-black/40 text-white border border-white/10 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/50 transition-all text-lg appearance-none font-mono">
                                    </div>
                                    <div class="text-left">
                                        <label for="shift-end-time-input" class="block text-xs font-bold text-teal-200 uppercase tracking-widest mb-2 ml-1">End Time</label>
                                        <input type="datetime-local" id="shift-end-time-input" class="w-full p-4 rounded-2xl bg-black/40 text-white border border-white/10 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/50 transition-all text-lg appearance-none font-mono">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <button id="preset-normal-btn" class="p-4 bg-teal-500/10 hover:bg-teal-500/30 border border-teal-500/30 text-teal-100 rounded-2xl transition-all font-bold text-sm hover:scale-[1.02]">Normal (19:00 - 07:00)</button>
                                    <button id="preset-overtime-btn" class="p-4 bg-emerald-500/10 hover:bg-emerald-500/30 border border-emerald-500/30 text-emerald-100 rounded-2xl transition-all font-bold text-sm hover:scale-[1.02]">Early (17:00 - 05:00)</button>
                                </div>
                                <div class="bg-black/20 p-6 rounded-2xl border border-white/5">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="font-bold text-gray-200 text-xs uppercase tracking-widest">Breaks</h3>
                                        <div class="flex gap-2">
                                            <button id="load-my-breaks-btn" class="text-[10px] uppercase font-bold tracking-wider px-3 py-1.5 bg-blue-500/20 hover:bg-blue-500/40 text-blue-200 rounded-lg border border-blue-500/20 transition-all">Defaults</button>
                                            <button id="add-break-btn" class="text-[10px] uppercase font-bold tracking-wider px-3 py-1.5 bg-green-500/20 hover:bg-green-500/40 text-green-200 rounded-lg border border-green-500/20 transition-all">+ Add</button>
                                        </div>
                                    </div>
                                    <div id="break-times-container" class="space-y-3 max-h-32 overflow-y-auto pr-2 custom-scrollbar"></div>
                                    <div class="mt-6 pt-6 border-t border-white/10 flex flex-col gap-3">
                                        <!-- Health Breaks Toggle -->
                                        <div class="flex items-center justify-between">
                                            <div class="text-left pr-4">
                                                <label for="health-breaks-toggle" class="text-sm font-bold text-gray-200 cursor-pointer select-none">Smart Health Breaks</label>
                                                <p class="text-[10px] text-gray-400 mt-0.5">Adds a 5m walk break every hour if gaps exist.</p>
                                            </div>
                                            <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in flex-shrink-0">
                                                <input type="checkbox" name="health-breaks-toggle" id="health-breaks-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 right-6 checked:border-green-400"/>
                                                <label for="health-breaks-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                                            </div>
                                        </div>
                                        <!-- Reset Breaches Toggle -->
                                        <div class="flex items-center justify-between">
                                            <div class="text-left pr-4">
                                                <label for="reset-breaches-toggle" class="text-sm font-bold text-gray-200 cursor-pointer select-none">Reset Completed Breaches</label>
                                                <p class="text-[10px] text-gray-400 mt-0.5">Uncheck all items to start fresh for this shift.</p>
                                            </div>
                                            <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in flex-shrink-0">
                                                <input type="checkbox" name="reset-breaches-toggle" id="reset-breaches-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 right-6 checked:border-rose-400"/>
                                                <label for="reset-breaches-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                             </div>
                            <button id="start-shift-btn" class="mt-8 w-full px-8 py-5 bg-gradient-to-r from-teal-600 to-emerald-600 text-white font-extrabold text-xl rounded-2xl shadow-lg hover:shadow-teal-500/40 hover:-translate-y-1 transition-all transform border-t border-white/20">Start Shift</button>
                        </div>
                        
                        <div id="shift-countdown-display" class="hidden w-full max-w-5xl flex flex-col gap-8">
                            <!-- Header Row -->
                            <div class="w-full flex flex-col md:flex-row justify-between items-center text-center md:text-left gap-4">
                                <div>
                                    <h2 id="shift-motivation-quote" class="text-3xl md:text-5xl font-bold tracking-tight text-white neon-text mb-1">Let's get this bread!</h2>
                                    <p id="shift-mode-label" class="text-teal-200/50 font-mono text-xs tracking-widest uppercase">Productivity Station Active</p>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <div class="flex items-center gap-4">
                                        <!-- Mode Toggle -->
                                        <div class="flex bg-slate-800/50 backdrop-blur-md rounded-xl p-1 border border-white/10">
                                            <button id="shift-mode-call" class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all text-slate-400 hover:text-white flex items-center gap-2 border border-transparent">
                                                <span>üìû</span> Calls
                                            </button>
                                            <button id="shift-mode-breach" class="px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all bg-rose-500/20 text-rose-300 border border-rose-500/30 shadow-[0_0_10px_rgba(244,63,94,0.2)] flex items-center gap-2">
                                                <span>‚ö°</span> Breach
                                            </button>
                                        </div>
                                        
                                        <div id="break-alert-banner" class="hidden py-2 px-6 bg-emerald-500/20 border border-emerald-500/50 text-emerald-300 rounded-full animate-pulse font-mono text-sm font-bold flex items-center gap-2">
                                            <span class="text-xl">üå±</span> RECHARGE MODE ACTIVE
                                        </div>
                                        <button id="share-shift-btn" class="p-3 bg-indigo-500/20 text-indigo-200 hover:text-white rounded-xl hover:bg-indigo-500/40 transition-all border border-indigo-500/20 shadow-lg backdrop-blur-sm" title="Share Shift Link">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                                        </button>
                                    </div>
                                    <!-- Pace Warning -->
                                    <div id="breach-pace-warning" class="hidden py-2 px-4 bg-rose-900/60 border border-rose-500/50 text-rose-200 rounded-xl animate-pulse flex items-center gap-3 backdrop-blur-md shadow-lg max-w-sm">
                                        <span class="text-xl">üìâ</span>
                                        <div class="text-left">
                                            <p class="text-[10px] font-bold uppercase tracking-wider text-rose-300">Target Missed</p>
                                            <p class="text-xs font-mono">Pace: <span id="pace-display-val" class="font-bold text-white">0</span>/hr</p>
                                            <p class="text-[10px] font-mono text-rose-300 mt-0.5">Behind: <span id="pace-missed-val" class="font-bold text-white">0</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Timer & Break -->
                            <div class="w-full glass-panel rounded-[2.5rem] p-8 md:p-12 flex flex-col items-center justify-center relative overflow-hidden">
                                <div class="flex items-baseline justify-center space-x-2 md:space-x-6 text-white drop-shadow-[0_0_35px_rgba(45,212,191,0.3)] z-10">
                                    <div class="text-center group"><div id="shift-hours-display" class="text-6xl sm:text-8xl md:text-9xl font-mono font-bold leading-none tracking-tighter group-hover:text-teal-200 transition-colors">00</div><div class="text-[10px] md:text-xs uppercase tracking-[0.4em] text-teal-400/70 font-bold mt-2 md:mt-4">Hours</div></div>
                                    <div class="text-4xl sm:text-7xl md:text-8xl font-thin text-teal-500/30 pb-4 md:pb-8 mx-1">:</div>
                                    <div class="text-center group"><div id="shift-minutes-display" class="text-6xl sm:text-8xl md:text-9xl font-mono font-bold leading-none tracking-tighter group-hover:text-teal-200 transition-colors">00</div><div class="text-[10px] md:text-xs uppercase tracking-[0.4em] text-teal-400/70 font-bold mt-2 md:mt-4">Minutes</div></div>
                                    <div class="text-4xl sm:text-7xl md:text-8xl font-thin text-teal-500/30 pb-4 md:pb-8 mx-1 hidden sm:block">:</div>
                                    <div class="text-center hidden sm:block group"><div id="shift-seconds-display" class="text-6xl sm:text-8xl md:text-9xl font-mono font-bold leading-none tracking-tighter opacity-50 group-hover:opacity-80 transition-opacity">00</div><div class="text-[10px] md:text-xs uppercase tracking-[0.4em] text-teal-400/50 font-bold mt-2 md:mt-4">Seconds</div></div>
                                </div>
                                <div id="next-break-container" class="mt-8 transition-opacity duration-500 z-10">
                                    <div class="inline-flex items-center gap-6 bg-white/5 backdrop-blur-md border border-white/10 rounded-full pl-6 pr-8 py-3 hover:bg-white/10 transition-colors">
                                        <div class="flex flex-col text-right"><span class="text-gray-400 text-[10px] uppercase tracking-widest font-bold">Next Break</span><span id="next-break-time-label" class="text-teal-300 text-xs font-bold">at 22:00</span></div>
                                        <div class="h-8 w-px bg-white/10"></div>
                                        <span id="time-to-next-break" class="text-2xl font-bold text-white font-mono">00:00:00</span>
                                    </div>
                                </div>
                                <!-- Break Active Overlay -->
                                <div id="break-active-display" class="hidden absolute inset-0 z-50 bg-slate-950/95 backdrop-blur-2xl flex flex-col items-center justify-center p-8 text-center">
                                    <div class="w-32 h-32 bg-emerald-500/10 rounded-full flex items-center justify-center mb-6 animate-bounce border border-emerald-500/20 shadow-[0_0_60px_rgba(16,185,129,0.2)]"><span class="text-6xl">‚òï</span></div>
                                    <h2 class="text-5xl font-bold text-white mb-2 neon-text tracking-tighter">Break Time</h2>
                                    <p class="text-xl text-emerald-300 mb-8 font-mono tracking-wide">Decompress. Hydrate. Move.</p>
                                    <div class="text-7xl font-bold font-mono text-white leading-none drop-shadow-2xl" id="break-timer-large">10:00</div>
                                    <p class="text-gray-500 mt-4 uppercase tracking-widest text-sm font-bold">Resuming Shortly</p>
                                </div>
                            </div>
                            <!-- Vibe Section -->
                            <div class="w-full">
                                <div id="current-hour-guide" class="vibe-card active glass-panel rounded-[2.5rem] p-8 md:p-10 relative overflow-hidden group hover:border-teal-500/30 transition-all duration-500 w-full">
                                    <div class="absolute -right-20 -top-20 w-60 h-60 bg-teal-600/10 rounded-full blur-3xl pointer-events-none group-hover:bg-teal-600/20 transition-all"></div>
                                    <div class="flex flex-col md:flex-row md:items-start justify-between mb-8 relative z-10 gap-4">
                                        <div>
                                            <div class="flex items-center gap-3 mb-2"><span id="current-hour-badge" class="px-3 py-1 bg-teal-500/20 text-teal-200 text-[10px] uppercase font-extrabold tracking-[0.2em] rounded-md border border-teal-500/30">Current Vibe</span><p id="current-hour-theme" class="text-teal-400 text-sm font-mono uppercase tracking-widest">// Calm Initiation</p></div>
                                            <h3 id="current-hour-title" class="text-3xl md:text-4xl font-bold text-white leading-tight tracking-tight">The Launchpad</h3>
                                        </div>
                                        <div class="w-16 h-16 bg-white/5 rounded-2xl flex flex-shrink-0 items-center justify-center border border-white/10 shadow-inner self-start"><span id="current-hour-icon" class="text-4xl filter drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">üöÄ</span></div>
                                    </div>
                                    <div id="current-hour-content" class="relative z-10 text-gray-300 text-lg leading-relaxed font-light grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                                    <div class="pt-6 mt-6 border-t border-white/5 relative z-10 flex justify-end">
                                        <button id="reset-shift-btn" class="text-xs text-red-400/60 hover:text-red-300 hover:bg-red-500/10 py-2 px-4 rounded-lg transition-all uppercase tracking-widest font-bold flex items-center gap-2 group-btn"><span>End Shift Early</span><span class="opacity-0 group-btn-hover:opacity-100 transition-opacity">‚Üí</span></button>
                                    </div>
                                </div>
                            </div>
                            <!-- Timeline -->
                            <div class="w-full mt-auto glass-panel rounded-3xl p-6">
                                <div class="flex justify-between text-xs text-gray-500 font-mono tracking-widest px-1 uppercase mb-3"><span id="shift-start-time-label">Start</span><span class="flex-grow text-center text-gray-600">Shift Progress</span><span id="shift-end-time-label">End</span></div>
                                <div id="shift-blocks-container" class="relative w-full h-12 bg-black/40 rounded-xl border border-white/5 shadow-inner overflow-hidden flex backdrop-blur-sm"></div>
                            </div>
                        </div>
                        <!-- End Modal -->
                        <div id="shift-end-message" class="hidden absolute inset-0 z-50 flex items-center justify-center p-4">
                            <div class="text-center max-w-2xl bg-slate-900/90 p-16 rounded-[3rem] backdrop-blur-2xl border border-white/20 shadow-2xl">
                                <h2 class="text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-600 mb-8 tracking-tighter">Shift Complete!</h2>
                                <p class="text-2xl text-gray-300 mb-12 leading-relaxed font-light">You've crushed it. Disconnect. Rest. Recharge.</p>
                                <div class="flex justify-center gap-6"><button id="new-shift-btn" class="px-10 py-4 bg-white text-slate-900 font-bold text-lg rounded-2xl hover:bg-teal-50 hover:scale-105 transition-all shadow-xl">Start New Shift</button></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hour Calculator -->
                <div id="hour-calculator" class="page-view container mx-auto px-6 py-10 max-w-5xl">
                    <h1 class="text-4xl font-extrabold text-slate-900 dark:text-white mb-8 tracking-tight">Hour Calculator</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white dark:bg-gray-800 p-8 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700">
                            <h2 class="text-xl font-bold text-white bg-indigo-600 -mx-8 -mt-8 mb-8 px-8 py-4 rounded-t-[2rem] shadow-sm">Enter Time Segments</h2>
                            <div id="time-entries" class="space-y-3"></div>
                            <button id="add-time-row" class="mt-6 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 text-sm font-bold flex items-center gap-2 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Add More Lines
                            </button>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-8 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700">
                            <h2 class="text-xl font-bold text-white bg-slate-800 -mx-8 -mt-8 mb-8 px-8 py-4 rounded-t-[2rem] shadow-sm">Total Calculation</h2>
                             <div class="space-y-6">
                                <div class="bg-slate-50 dark:bg-slate-700/50 p-6 rounded-2xl text-center border border-slate-100 dark:border-slate-600">
                                    <div id="total-time-hms" class="text-4xl font-mono font-bold text-slate-800 dark:text-white tracking-tight">00:00:00</div>
                                    <div class="text-xs font-bold uppercase tracking-wider text-slate-400 mt-2">Hours : Minutes : Seconds</div>
                                </div>
                                <div class="bg-slate-50 dark:bg-slate-700/50 p-6 rounded-2xl text-center border border-slate-100 dark:border-slate-600">
                                    <div id="total-time-decimal" class="text-4xl font-mono font-bold text-slate-800 dark:text-white tracking-tight">0.00</div>
                                     <div class="text-xs font-bold uppercase tracking-wider text-slate-400 mt-2">Decimal Hours</div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <button id="calculate-time-btn" class="col-span-2 w-full py-4 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-500/20 transition-all hover:scale-[1.02]">Calculate</button>
                                    <button id="clear-time-btn" class="w-full py-3 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold rounded-xl hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">Clear</button>
                                    <button id="print-time-btn" class="w-full py-3 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold rounded-xl hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">Print</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div id="settings" class="page-view container mx-auto px-6 py-10 max-w-4xl">
                      <h1 class="text-4xl font-extrabold text-slate-900 dark:text-white mb-8 tracking-tight">Settings</h1>
                      <div class="space-y-8">
                        <div class="bg-white dark:bg-gray-800 p-8 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700">
                            <h2 class="text-xl font-bold mb-6 pb-4 border-b border-slate-100 dark:border-slate-700 text-slate-900 dark:text-white">Appearance</h2>
                            <div class="flex items-center justify-between">
                                <div>
                                    <label for="dark-mode-toggle" class="font-bold text-lg text-slate-800 dark:text-slate-200 block">Dark Mode</label>
                                    <p class="text-slate-500 text-sm mt-1">Switch between light and dark themes.</p>
                                </div>
                                <button id="theme-toggle" type="button" class="bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600 focus:outline-none rounded-xl p-3 transition-colors">
                                    <svg id="theme-toggle-dark-icon" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                                    <svg id="theme-toggle-light-icon" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                                </button>
                            </div>
                        </div>
                      </div>
                </div>

                <!-- Idea Board -->
                <div id="idea-board" class="page-view h-full relative overflow-hidden">
                    <div id="idea-board-container" class="w-full h-full"></div>
                    <button id="add-note-btn" class="absolute bottom-8 right-8 px-8 py-4 bg-yellow-400 text-yellow-900 font-bold rounded-full shadow-2xl hover:bg-yellow-300 hover:scale-110 transition-all z-20 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Add Note
                    </button>
                </div>

                <!-- Breach List -->
                <div id="breach-list" class="page-view container mx-auto px-6 py-10 max-w-7xl">
                    <div class="flex flex-col lg:flex-row gap-8 relative items-start">
                        
                        <!-- Left Panel: Hourly Control Center -->
                        <div class="lg:w-1/3 shrink-0 flex flex-col gap-6">
                            <!-- Current Session Card -->
                            <div class="bg-gradient-to-br from-slate-900 to-slate-800 text-white p-8 rounded-[2.5rem] shadow-2xl border border-white/10 relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/20 rounded-full blur-3xl -mr-10 -mt-10"></div>
                                
                                <div class="relative z-10">
                                    <div class="flex justify-between items-start mb-6">
                                        <div>
                                            <p class="text-indigo-300 text-xs font-bold uppercase tracking-widest mb-1">Current Session</p>
                                            <h2 id="breach-current-hour-label" class="text-3xl font-mono font-bold">--:00 - --:00</h2>
                                        </div>
                                        <div class="animate-pulse">
                                            <span class="w-3 h-3 bg-emerald-500 rounded-full inline-block shadow-[0_0_10px_#10b981]"></span>
                                        </div>
                                    </div>

                                    <!-- Progress Circle / Stats -->
                                    <div class="flex flex-col items-center justify-center py-6">
                                        <div class="relative w-40 h-40">
                                            <svg class="w-full h-full transform -rotate-90">
                                                <circle cx="80" cy="80" r="70" stroke="currentColor" stroke-width="12" fill="transparent" class="text-slate-700" />
                                                <circle id="breach-hourly-progress-circle" cx="80" cy="80" r="70" stroke="currentColor" stroke-width="12" fill="transparent" stroke-dasharray="440" stroke-dashoffset="440" class="text-indigo-500 transition-all duration-1000 ease-out" />
                                            </svg>
                                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                                <span id="breach-hourly-count" class="text-4xl font-bold">0</span>
                                                <span class="text-xs text-slate-400 uppercase font-bold mt-1">Breaches</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Target Info -->
                                    <div class="bg-white/5 rounded-2xl p-6 mb-6 border border-white/5 backdrop-blur-sm">
                                        <div class="flex flex-col gap-4">
                                            <div class="flex justify-between items-center">
                                                <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Hourly Target</p>
                                                <p id="breach-hourly-target-display" class="text-2xl font-bold text-white">--</p>
                                            </div>
                                            <div class="w-full h-px bg-white/10"></div>
                                            <div class="flex justify-between items-center">
                                                <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Pace Required</p>
                                                <p id="breach-pace-status" class="text-lg font-bold text-emerald-400">On Track</p>
                                            </div>
                                        </div>
                                    </div>

                                    <button id="sync-breach-target-btn" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl transition-all shadow-lg shadow-indigo-500/30 flex items-center justify-center gap-2 group">
                                        <svg class="w-5 h-5 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                        Sync Target to Time
                                    </button>
                                    <p class="text-[10px] text-center text-slate-500 mt-3">Calculates target based on remaining minutes in hour.</p>
                                </div>
                            </div>

                            <!-- Mini Stats -->
                             <div class="grid grid-cols-2 gap-4 grow-0">
                                <div class="bg-white dark:bg-gray-800 p-5 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700">
                                    <p class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase">Today Total</p>
                                    <p id="breach-today-total" class="text-2xl font-bold text-slate-900 dark:text-white mt-1">0</p>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-5 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700">
                                    <p class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase">Efficiency</p>
                                    <p id="breach-efficiency" class="text-2xl font-bold text-slate-900 dark:text-white mt-1">100%</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Panel: The List & History -->
                        <div class="flex-1 flex flex-col bg-white dark:bg-gray-800 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-slate-700 min-h-[600px]">
                            <!-- Tabs -->
                            <div class="flex border-b border-slate-100 dark:border-slate-700 px-8 pt-6 sticky top-0 bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm z-10 rounded-t-[2.5rem]">
                                <button id="tab-breach-current" class="pb-4 px-4 text-sm font-bold text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400 transition-colors">Current Hour</button>
                                <button id="tab-breach-history" class="pb-4 px-4 text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition-colors">History Log</button>
                            </div>

                            <!-- Current Hour View -->
                            <div id="view-breach-current" class="flex-1 flex flex-col p-8">
                                <div class="flex gap-3 mb-6 sticky top-[72px] z-10">
                                    <input type="text" id="breach-item-input" class="flex-1 bg-slate-50 dark:bg-gray-700/80 border border-slate-200 dark:border-gray-600 rounded-xl px-5 py-3 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-indigo-500 backdrop-blur-md shadow-lg transition-all" placeholder="Log a breach item..." autocomplete="off">
                                    <button id="add-breach-item-btn" class="px-6 py-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold rounded-xl hover:opacity-90 transition-opacity shadow-lg">
                                        Add
                                    </button>
                                </div>
                                
                                <div id="breach-list-uncompleted-container" class="flex-1 space-y-3 pb-8">
                                    <!-- Items go here -->
                                </div>
                            </div>

                            <!-- History View -->
                            <div id="view-breach-history" class="hidden flex-1 flex-col p-0">
                                <div id="breach-history-container" class="flex-1 p-8 space-y-6 pb-8">
                                    <!-- History groups go here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Salary Calculator -->
                <div id="salary-calculator" class="page-view container mx-auto px-6 py-10 max-w-5xl">
                    <h1 class="text-4xl font-extrabold text-slate-900 dark:text-white mb-8 tracking-tight">Salary Calculator <span class="text-indigo-600 text-2xl ml-2 font-medium">UK 2024/25</span></h1>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Input Section -->
                        <div class="bg-white dark:bg-gray-800 p-8 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700 space-y-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3 uppercase tracking-wider">Input Type</label>
                                <div class="flex gap-4 p-1 bg-slate-100 dark:bg-slate-700/50 rounded-xl">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="income-type" value="annual" class="peer sr-only" checked>
                                        <div class="text-center py-2 rounded-lg text-sm font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm dark:peer-checked:bg-slate-600 dark:peer-checked:text-white transition-all">Annual</div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="income-type" value="monthly" class="peer sr-only">
                                        <div class="text-center py-2 rounded-lg text-sm font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm dark:peer-checked:bg-slate-600 dark:peer-checked:text-white transition-all">Monthly</div>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label for="gross-income" class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Gross Income (¬£)</label>
                                <input type="number" id="gross-income" class="w-full px-4 py-3 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg font-mono dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all" placeholder="50000">
                            </div>
                             <div>
                                <label for="tax-code" class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Tax Code</label>
                                <input type="text" id="tax-code" value="1257L" class="w-full px-4 py-3 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg font-mono dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all">
                            </div>
                            <button id="calculate-salary-btn" class="w-full py-4 bg-indigo-600 text-white font-bold text-lg rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition-all hover:scale-[1.02]">Calculate Take-Home</button>
                        </div>
                        <!-- Output Section -->
                        <div id="salary-results" class="hidden space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-emerald-50 dark:bg-emerald-900/20 p-6 rounded-[2rem] border border-emerald-100 dark:border-emerald-800 text-center">
                                    <p class="text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider mb-2">Annual Net</p>
                                    <p id="annual-net" class="text-3xl font-extrabold text-emerald-700 dark:text-emerald-300 font-mono">¬£0.00</p>
                                </div>
                                <div class="bg-emerald-50 dark:bg-emerald-900/20 p-6 rounded-[2rem] border border-emerald-100 dark:border-emerald-800 text-center">
                                    <p class="text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider mb-2">Monthly Net</p>
                                    <p id="monthly-net" class="text-3xl font-extrabold text-emerald-700 dark:text-emerald-300 font-mono">¬£0.00</p>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-8 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700">
                                <h3 class="font-bold text-lg text-slate-900 dark:text-white mb-6 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                    Detailed Breakdown
                                </h3>
                                <!-- Tables handled by JS -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="salary-breakdown-container">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Overtime Tracker -->
                 <div id="overtime-tracker" class="page-view container mx-auto px-6 py-10 max-w-6xl">
                    <h1 class="text-4xl font-extrabold text-slate-900 dark:text-white mb-8 tracking-tight">Overtime Tracker</h1>
                    
                    <div id="overtime-fund-totals" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <!-- Totals will be generated here -->
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-8 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700 h-fit">
                            <h2 class="text-xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-2">
                                <span class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 flex items-center justify-center text-sm">+</span>
                                New Entry
                            </h2>
                            <div class="space-y-5">
                                <div>
                                    <label for="overtime-date" class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Date</label>
                                    <input type="date" id="overtime-date" class="w-full px-4 py-3 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="overtime-hours" class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Hours</label>
                                        <input type="number" id="overtime-hours" placeholder="5.5" class="w-full px-4 py-3 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all">
                                    </div>
                                     <div>
                                        <label for="overtime-rate" class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Rate (¬£)</label>
                                        <input type="number" id="overtime-rate" placeholder="15.00" class="w-full px-4 py-3 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all">
                                    </div>
                                </div>
                                <div>
                                    <label for="overtime-allocation" class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Allocation</label>
                                    <select id="overtime-allocation" class="w-full px-4 py-3 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all">
                                        <option>Savings</option>
                                        <option>Holiday</option>
                                        <option value="Other">Other (Specify)</option>
                                    </select>
                                    <input type="text" id="overtime-allocation-custom" class="mt-3 hidden w-full px-4 py-3 rounded-xl border-gray-200 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-700/50 dark:border-gray-600 dark:text-white transition-all" placeholder="Custom allocation name">
                                </div>
                                <button id="add-overtime-btn" class="w-full py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold rounded-xl hover:opacity-90 shadow-lg transition-all mt-2">Add Entry</button>
                            </div>
                        </div>

                        <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-8 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700">
                            <h2 class="text-xl font-bold mb-6 text-slate-900 dark:text-white">History Log</h2>
                            <div id="overtime-list" class="space-y-6">
                               <!-- Entries will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ball Game -->
                <div id="ball-game" class="page-view h-full">
                    <div id="ball-game-container">
                        <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-6 tracking-tight">Break Game</h1>
                        <div id="game-info" class="bg-slate-800/50 p-4 rounded-2xl backdrop-blur-sm border border-slate-700/50 flex justify-between w-full max-w-xl mb-6">
                            <span id="game-score" class="text-indigo-300">Score: 0</span>
                            <span id="game-lives" class="text-pink-300">Lives: 3</span>
                            <span id="game-high-score" class="text-emerald-300">High Score: 0</span>
                        </div>
                        <canvas id="game-canvas" width="500" height="400" class="shadow-2xl shadow-indigo-500/20"></canvas>
                        <div id="game-controls" class="mt-8">
                            <button id="start-game-btn" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition-all hover:scale-105">Start</button>
                            <button id="reset-game-btn" class="px-8 py-3 bg-slate-700 text-white rounded-xl font-bold hover:bg-slate-600 transition-all ml-4">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // ... (Existing NoiseGenerator Class logic - Unchanged) ...
        class NoiseGenerator {
            constructor() {
                this.ctx = null;
                // Nodes for Noise
                this.noiseSource = null;
                this.filterNode = null;
                this.secondarySource = null; // For texture layers
                this.secondaryFilter = null;
                
                // Nodes for Oscillators (Gamma/Waves/Lofi)
                this.carrierOsc = null;
                this.lfoOsc = null;
                this.lfoGain = null;
                
                // Lofi/Texture Specifics
                this.textureInterval = null; // Replaced lofiInterval to be generic
                this.beatStep = 0;
                
                this.gainNode = null;
                this.isPlaying = false;
                this.type = null;
            }

            init() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                    this.gainNode = this.ctx.createGain();
                    this.gainNode.connect(this.ctx.destination);
                    this.gainNode.gain.value = 0.3; // Default volume
                }
            }

            createNoiseBuffer(type) {
                if (!this.ctx) return;
                const bufferSize = 2 * this.ctx.sampleRate; // 2 seconds buffer
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const output = buffer.getChannelData(0);

                if (type === 'white') {
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = Math.random() * 2 - 1;
                    }
                } else if (type === 'pink') {
                    let b0, b1, b2, b3, b4, b5, b6;
                    b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        b0 = 0.99886 * b0 + white * 0.0555179;
                        b1 = 0.99332 * b1 + white * 0.0750759;
                        b2 = 0.96900 * b2 + white * 0.1538520;
                        b3 = 0.86650 * b3 + white * 0.3104856;
                        b4 = 0.55000 * b4 + white * 0.5329522;
                        b5 = -0.7616 * b5 - white * 0.0168980;
                        output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                        output[i] *= 0.11; 
                        b6 = white * 0.115926;
                    }
                } else if (type === 'brown') {
                    let lastOut = 0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        output[i] = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = output[i];
                        output[i] *= 3.5; 
                    }
                }
                return buffer;
            }

            toggle(type) {
                this.init();
                if (this.isPlaying && this.type === type) {
                    this.stop();
                    return false; 
                }
                if (this.isPlaying) {
                    this.stop();
                }
                this.type = type;
                this.play();
                return true; 
            }

            play() {
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
                
                this.stopNodes();

                if (this.type === 'gamma') {
                    // 40Hz Gamma Logic
                    this.carrierOsc = this.ctx.createOscillator();
                    this.carrierOsc.type = 'sine';
                    this.carrierOsc.frequency.value = 200; 

                    this.lfoGain = this.ctx.createGain();
                    this.lfoGain.gain.value = 0.5; 

                    this.lfoOsc = this.ctx.createOscillator();
                    this.lfoOsc.type = 'sine';
                    this.lfoOsc.frequency.value = 40;

                    this.lfoOsc.connect(this.lfoGain.gain);
                    this.carrierOsc.connect(this.lfoGain);
                    this.lfoGain.connect(this.gainNode);

                    this.carrierOsc.start();
                    this.lfoOsc.start();
                } 
                else if (this.type === 'waves' || this.type === 'beach') {
                    // Ocean Logic (Waves) + Seagulls for Beach
                    const buffer = this.createNoiseBuffer('brown');
                    this.noiseSource = this.ctx.createBufferSource();
                    this.noiseSource.buffer = buffer;
                    this.noiseSource.loop = true;

                    this.lfoOsc = this.ctx.createOscillator();
                    this.lfoOsc.type = 'sine';
                    this.lfoOsc.frequency.value = 0.15; // Slow swell

                    this.lfoGain = this.ctx.createGain();
                    this.lfoGain.gain.value = 0.5; 

                    this.lfoOsc.connect(this.lfoGain.gain);
                    this.noiseSource.connect(this.lfoGain);
                    this.lfoGain.connect(this.gainNode);

                    this.noiseSource.start();
                    this.lfoOsc.start();

                    if (this.type === 'beach') {
                        // Add intermittent seagulls
                         this.textureInterval = setInterval(() => {
                            if (Math.random() > 0.8) { // Occasional chirp
                                this.playSeagull();
                            }
                        }, 2000);
                    }
                }
                else if (this.type === 'train') {
                    // Train: Rhythmic Brown Noise
                    // Base rumble
                    const buffer = this.createNoiseBuffer('pink'); // Pink noise for "hiss" of wheels
                    this.noiseSource = this.ctx.createBufferSource();
                    this.noiseSource.buffer = buffer;
                    this.noiseSource.loop = true;

                    // Lowpass to muffle it
                    this.filterNode = this.ctx.createBiquadFilter();
                    this.filterNode.type = 'lowpass';
                    this.filterNode.frequency.value = 400;

                    // Rhythmic Gain (The "Chug")
                    this.lfoOsc = this.ctx.createOscillator();
                    this.lfoOsc.type = 'square'; // Harsh on/off
                    this.lfoOsc.frequency.value = 4; // 4 chugs per second

                    // Smooth the square wave slightly
                    const lfoFilter = this.ctx.createBiquadFilter();
                    lfoFilter.type = 'lowpass';
                    lfoFilter.frequency.value = 10;

                    this.lfoGain = this.ctx.createGain();
                    this.lfoGain.gain.value = 0.2; // Base volume

                    // Connect LFO to Gain
                    const rhythmGain = this.ctx.createGain();
                    rhythmGain.gain.value = 0.3; // Modulation depth

                    this.lfoOsc.connect(lfoFilter);
                    lfoFilter.connect(rhythmGain);
                    rhythmGain.connect(this.lfoGain.gain);

                    this.noiseSource.connect(this.filterNode);
                    this.filterNode.connect(this.lfoGain);
                    this.lfoGain.connect(this.gainNode);

                    this.noiseSource.start();
                    this.lfoOsc.start();
                }
                else if (this.type === 'airplane') {
                    // Airplane: Deep Brown Noise Drone
                    const buffer = this.createNoiseBuffer('brown');
                    this.noiseSource = this.ctx.createBufferSource();
                    this.noiseSource.buffer = buffer;
                    this.noiseSource.loop = true;

                    // Lowpass filter for the cabin "hum"
                    this.filterNode = this.ctx.createBiquadFilter();
                    this.filterNode.type = 'lowpass';
                    this.filterNode.frequency.value = 150; 
                    
                    // Add a secondary Pink noise for high-end "air" hiss
                    const windBuffer = this.createNoiseBuffer('pink');
                    this.secondarySource = this.ctx.createBufferSource();
                    this.secondarySource.buffer = windBuffer;
                    this.secondarySource.loop = true;

                    const windFilter = this.ctx.createBiquadFilter();
                    windFilter.type = 'bandpass';
                    windFilter.frequency.value = 500;
                    
                    const windGain = this.ctx.createGain();
                    windGain.gain.value = 0.1;

                    this.noiseSource.connect(this.filterNode);
                    this.filterNode.connect(this.gainNode);

                    this.secondarySource.connect(windFilter);
                    windFilter.connect(windGain);
                    windGain.connect(this.gainNode);

                    this.noiseSource.start();
                    this.secondarySource.start();
                }
                else if (this.type === 'fire') {
                    // Fire: Brown noise rumble + Crackle
                    const buffer = this.createNoiseBuffer('brown');
                    this.noiseSource = this.ctx.createBufferSource();
                    this.noiseSource.buffer = buffer;
                    this.noiseSource.loop = true;

                    // Filter rumble
                    this.filterNode = this.ctx.createBiquadFilter();
                    this.filterNode.type = 'lowpass';
                    this.filterNode.frequency.value = 120;
                    
                    this.noiseSource.connect(this.filterNode);
                    this.filterNode.connect(this.gainNode);
                    this.noiseSource.start();

                    // Crackle generator
                    this.textureInterval = setInterval(() => {
                        if (Math.random() > 0.6) { 
                            this.playCrackle();
                        }
                    }, 100);
                }
                else if (this.type === 'forest') {
                    // Forest: Filtered Pink (Wind) + Birds
                    const buffer = this.createNoiseBuffer('pink');
                    this.noiseSource = this.ctx.createBufferSource();
                    this.noiseSource.buffer = buffer;
                    this.noiseSource.loop = true;

                    // Dynamic wind filter (slowly changing)
                    this.filterNode = this.ctx.createBiquadFilter();
                    this.filterNode.type = 'lowpass';
                    this.filterNode.frequency.value = 400;

                    this.lfoOsc = this.ctx.createOscillator();
                    this.lfoOsc.type = 'sine';
                    this.lfoOsc.frequency.value = 0.1; // Slow wind shifts
                    
                    const lfoAmp = this.ctx.createGain();
                    lfoAmp.gain.value = 200; // Shift freq by +/- 200

                    this.lfoOsc.connect(lfoAmp);
                    lfoAmp.connect(this.filterNode.frequency);

                    this.noiseSource.connect(this.filterNode);
                    this.filterNode.connect(this.gainNode);
                    this.noiseSource.start();
                    this.lfoOsc.start();

                    // Birds
                    this.textureInterval = setInterval(() => {
                        if (Math.random() > 0.85) { 
                            this.playBird();
                        }
                    }, 1500);
                }
                else if (this.type === 'city') {
                    // City: Brown noise rumble + Filtered traffic swells
                    // 1. Background Rumble (Brown)
                    const bgBuffer = this.createNoiseBuffer('brown');
                    this.noiseSource = this.ctx.createBufferSource();
                    this.noiseSource.buffer = bgBuffer;
                    this.noiseSource.loop = true;
                    
                    const bgGain = this.ctx.createGain();
                    bgGain.gain.value = 0.4;
                    
                    this.noiseSource.connect(bgGain);
                    bgGain.connect(this.gainNode);
                    this.noiseSource.start();

                    // 2. Traffic Swells (Filtered Pink Noise)
                    const trafficBuffer = this.createNoiseBuffer('pink');
                    this.secondarySource = this.ctx.createBufferSource();
                    this.secondarySource.buffer = trafficBuffer;
                    this.secondarySource.loop = true;

                    this.filterNode = this.ctx.createBiquadFilter();
                    this.filterNode.type = 'lowpass';
                    this.filterNode.frequency.value = 400;

                    // LFO to modulate traffic filter (simulating cars passing)
                    this.lfoOsc = this.ctx.createOscillator();
                    this.lfoOsc.type = 'sine';
                    this.lfoOsc.frequency.value = 0.1; // Slow swell

                    const filterModGain = this.ctx.createGain();
                    filterModGain.gain.value = 300; // Modulate frequency by +/- 300Hz

                    this.lfoOsc.connect(filterModGain);
                    filterModGain.connect(this.filterNode.frequency);
                    
                    this.secondarySource.connect(this.filterNode);
                    this.filterNode.connect(this.gainNode);
                    
                    this.secondarySource.start();
                    this.lfoOsc.start();
                }
                else if (this.type === 'cafe') {
                    // 1. Chatter (Filtered Pink)
                    const chatterBuffer = this.createNoiseBuffer('pink');
                    this.noiseSource = this.ctx.createBufferSource();
                    this.noiseSource.buffer = chatterBuffer;
                    this.noiseSource.loop = true;

                    this.filterNode = this.ctx.createBiquadFilter();
                    this.filterNode.type = 'bandpass';
                    this.filterNode.frequency.value = 800; // Speech range
                    this.filterNode.Q.value = 1;

                    this.noiseSource.connect(this.filterNode);
                    this.filterNode.connect(this.gainNode);
                    this.noiseSource.start();

                    // 2. Random "Clink" generator
                    this.textureInterval = setInterval(() => {
                        if (Math.random() > 0.7) { // 30% chance per second
                            this.playClink();
                        }
                    }, 1000);
                }
                else if (this.type === 'lofi') {
                    // Lofi: Vinyl Crackle + Beat Loop
                    // 1. Vinyl Crackle (Highpass Pink Noise)
                    const crackleBuffer = this.createNoiseBuffer('pink');
                    this.noiseSource = this.ctx.createBufferSource();
                    this.noiseSource.buffer = crackleBuffer;
                    this.noiseSource.loop = true;

                    this.filterNode = this.ctx.createBiquadFilter();
                    this.filterNode.type = 'highpass';
                    this.filterNode.frequency.value = 2000;
                    
                    const crackleGain = this.ctx.createGain();
                    crackleGain.gain.value = 0.15; // Quiet

                    this.noiseSource.connect(this.filterNode);
                    this.filterNode.connect(crackleGain);
                    crackleGain.connect(this.gainNode);
                    this.noiseSource.start();

                    // 2. Beat Sequencer
                    this.beatStep = 0;
                    const bpm = 70;
                    const stepTime = (60 / bpm) * 1000 / 2; // 8th notes
                    
                    this.playLofiStep(); // Play immediately
                    this.textureInterval = setInterval(() => this.playLofiStep(), stepTime);
                    
                    // 3. Drone Chord (Pad)
                    this.playLofiPad();
                }
                else {
                    // Standard Noise Logic (White, Pink, Brown, Green, Rain)
                    let bufferType = this.type;
                    if (this.type === 'green') bufferType = 'white'; 
                    if (this.type === 'rain') bufferType = 'pink';

                    const buffer = this.createNoiseBuffer(bufferType);
                    this.noiseSource = this.ctx.createBufferSource();
                    this.noiseSource.buffer = buffer;
                    this.noiseSource.loop = true;

                    if (this.type === 'green') {
                        this.filterNode = this.ctx.createBiquadFilter();
                        this.filterNode.type = 'lowpass';
                        this.filterNode.frequency.value = 500;
                        this.filterNode.Q.value = 1;
                        this.noiseSource.connect(this.filterNode);
                        this.filterNode.connect(this.gainNode);
                    } else if (this.type === 'rain') {
                        this.filterNode = this.ctx.createBiquadFilter();
                        this.filterNode.type = 'lowpass';
                        this.filterNode.frequency.value = 800;
                        this.noiseSource.connect(this.filterNode);
                        this.filterNode.connect(this.gainNode);
                    } else {
                        this.noiseSource.connect(this.gainNode);
                    }
                    this.noiseSource.start();
                }
                this.isPlaying = true;
            }

            // Helper for Seagulls (Beach)
            playSeagull() {
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1500, t);
                osc.frequency.exponentialRampToValueAtTime(1000, t + 0.4);
                
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.05, t + 0.1);
                gain.gain.linearRampToValueAtTime(0, t + 0.4);

                osc.connect(gain);
                gain.connect(this.gainNode);
                
                osc.start(t);
                osc.stop(t + 0.5);
            }

            // Helper for Fire Crackle
            playCrackle() {
                const t = this.ctx.currentTime;
                const buffer = this.createNoiseBuffer('white');
                const source = this.ctx.createBufferSource();
                source.buffer = buffer;
                
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 1000;

                const gain = this.ctx.createGain();
                // Short, sharp bursts
                gain.gain.setValueAtTime(0.1 + Math.random() * 0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);

                source.connect(filter);
                filter.connect(gain);
                gain.connect(this.gainNode);
                
                source.start(t);
                source.stop(t + 0.06);
            }

            // Helper for Birds (Forest)
            playBird() {
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.type = 'sine';
                // Randomize pitch high
                const startFreq = 2000 + Math.random() * 1000;
                osc.frequency.setValueAtTime(startFreq, t);
                
                // Simple chirp pattern (up-down or down)
                if (Math.random() > 0.5) {
                    osc.frequency.linearRampToValueAtTime(startFreq + 500, t + 0.1);
                } else {
                    osc.frequency.linearRampToValueAtTime(startFreq - 500, t + 0.1);
                }
                
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.05, t + 0.02);
                gain.gain.linearRampToValueAtTime(0, t + 0.15);

                osc.connect(gain);
                gain.connect(this.gainNode);
                
                osc.start(t);
                osc.stop(t + 0.2);
            }

            // Helper for Cafe Sound
            playClink() {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                // Random freq between 2000 and 4000
                osc.frequency.value = 2000 + Math.random() * 2000;
                
                gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.1);

                osc.connect(gain);
                gain.connect(this.gainNode);
                
                osc.start();
                osc.stop(this.ctx.currentTime + 0.15);
            }

            // Helpers for Lofi
            playLofiPad() {
                // Cm9 Chord Pad: C3, Eb3, G3, Bb3, D4
                const freqs = [130.81, 155.56, 196.00, 233.08, 293.66];
                freqs.forEach(f => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    
                    osc.type = 'triangle'; // Softer than square, richer than sine
                    osc.frequency.value = f;
                    
                    // Detune slightly for "wobbly" lofi feel
                    osc.detune.value = Math.random() * 10 - 5;

                    // Filter to make it mellow
                    const filter = this.ctx.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.value = 800;

                    gain.gain.value = 0.03; // Very quiet background

                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.gainNode);
                    
                    osc.start();
                    // Store in secondarySource array if we wanted to stop individually, 
                    // but stopNodes() cleans up generally.
                    this.secondarySource = osc; // Just tracking one for non-null check
                });
            }

            playLofiStep() {
                const t = this.ctx.currentTime;
                // Beat Pattern (8 steps)
                // K - - - S - - - (Kick on 0, Snare on 4)
                // Hats on 0, 2, 4, 6
                
                // Kick
                if (this.beatStep === 0 || this.beatStep === 5) { // Syncopated kick
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.frequency.setValueAtTime(150, t);
                    osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
                    gain.gain.setValueAtTime(0.5, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
                    osc.connect(gain);
                    gain.connect(this.gainNode);
                    osc.start(t);
                    osc.stop(t + 0.5);
                }

                // Snare
                if (this.beatStep === 4) {
                    const noise = this.ctx.createBufferSource();
                    noise.buffer = this.createNoiseBuffer('white');
                    const gain = this.ctx.createGain();
                    const filter = this.ctx.createBiquadFilter();
                    filter.type = 'highpass';
                    filter.frequency.value = 1000;
                    
                    gain.gain.setValueAtTime(0.3, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
                    
                    noise.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.gainNode);
                    noise.start(t);
                    noise.stop(t + 0.2);
                }

                // Hi-hat (Closed)
                if (this.beatStep % 2 === 0) {
                    const noise = this.ctx.createBufferSource();
                    noise.buffer = this.createNoiseBuffer('white');
                    const gain = this.ctx.createGain();
                    const filter = this.ctx.createBiquadFilter();
                    filter.type = 'highpass';
                    filter.frequency.value = 5000;
                    
                    // Vary volume slightly for "human" feel
                    const vol = 0.05 + Math.random() * 0.02;
                    gain.gain.setValueAtTime(vol, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
                    
                    noise.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.gainNode);
                    noise.start(t);
                    noise.stop(t + 0.05);
                }

                this.beatStep = (this.beatStep + 1) % 8;
            }

            stop() {
                this.stopNodes();
                this.isPlaying = false;
            }

            stopNodes() {
                // Stop basic noises
                if (this.noiseSource) {
                    try { this.noiseSource.stop(); } catch(e){}
                    this.noiseSource.disconnect();
                    this.noiseSource = null;
                }
                if (this.filterNode) {
                    this.filterNode.disconnect();
                    this.filterNode = null;
                }
                
                // Stop secondary sources (used in City/Lofi)
                if (this.secondarySource) {
                    try { this.secondarySource.stop(); } catch(e){}
                    this.secondarySource.disconnect();
                    this.secondarySource = null;
                }

                // Stop Oscillators
                if (this.carrierOsc) {
                    try { this.carrierOsc.stop(); } catch(e){}
                    this.carrierOsc.disconnect();
                    this.carrierOsc = null;
                }
                if (this.lfoOsc) {
                    try { this.lfoOsc.stop(); } catch(e){}
                    this.lfoOsc.disconnect();
                    this.lfoOsc = null;
                }
                if (this.lfoGain) {
                    this.lfoGain.disconnect();
                    this.lfoGain = null;
                }
                
                // Clear Intervals (Cafe/Lofi/Beach/Fire/Forest)
                if (this.textureInterval) {
                    clearInterval(this.textureInterval);
                    this.textureInterval = null;
                }
            }

            setVolume(val) {
                if (this.gainNode) {
                     this.gainNode.gain.value = val;
                }
            }
        }

        const curriculumData = [
            {
                module: "Ikigai (Áîü„ÅçÁî≤Êñê)",
                themeColor: "rose",
                icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />`,
                description: "Discover your 'reason for being' by finding the intersection of what you love, what you're good at, what the world needs, and what you can be paid for.",
                topics: [
                    { title: "Passion", items: ["What do you love?", "What are you good at?"] },
                    { title: "Mission", items: ["What does the world need?", "What can you contribute?"] },
                    { title: "Vocation & Profession", items: ["What can you be paid for?", "Synthesizing your Ikigai"] },
                ]
            },
            {
                module: "Eisenhower Matrix",
                themeColor: "blue",
                icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2z" />`,
                description: "Organize tasks by urgency and importance to prioritize effectively and eliminate time-wasting activities.",
                topics: [
                    { title: "Quadrant 1: Urgent & Important", items: ["Identify crises and deadlines", "Strategy: Do immediately"] },
                    { title: "Quadrant 2: Not Urgent & Important", items: ["Focus on long-term goals", "Strategy: Schedule and plan"] },
                    { title: "Quadrant 3: Urgent & Not Important", items: ["Minimize interruptions", "Strategy: Delegate if possible"] },
                    { title: "Quadrant 4: Not Urgent & Not Important", items: ["Recognize time-wasters", "Strategy: Eliminate or reduce"] },
                ]
            },
            {
                module: "Pareto Principle (80/20)",
                themeColor: "emerald",
                icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M15.5,6.8l-3.6,9.5c-0.2,0.5-0.9,0.5-1.1,0L5.5,6.8C5.3,6.3,5.6,5.7,6.2,5.7h12.6C19.4,5.7,19.7,6.3,19.5,6.8z M12.5,18.8c0,0.6-0.4,1-1,1h-3c-0.6,0-1-0.4-1-1v-2.5h5V18.8z"/>`,
                description: "Focus on the 20% of activities that will yield 80% of the results, maximizing your effort and impact.",
                topics: [
                    { title: "Core Concept", items: ["Understanding the 80/20 ratio", "Separating the vital few from the trivial many"] },
                    { title: "Application", items: ["Analyze tasks and efforts", "Identify your high-impact activities", "Focus energy on the 20%"] },
                ]
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const getStartedBtn = document.getElementById('get-started-btn');
            const landingPage = document.getElementById('landing-page');
            const appLayout = document.getElementById('app-layout');
            const logoutBtn = document.getElementById('logout-btn');
            const openSidebarBtn = document.getElementById('open-sidebar-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const sidebar = document.getElementById('sidebar');
            const landingCanvas = document.getElementById('landing-canvas');
            
            const grid = document.getElementById('curriculum-grid');

            // Modal elements
            const alertModal = document.getElementById('alert-modal');
            const alertMessage = document.getElementById('alert-message');
            const alertCloseBtn = document.getElementById('alert-close-btn');

            let dashboardInitialized = false;

            // --- Generic Modal Functions ---
            function showAlert(message) {
                alertMessage.textContent = message;
                alertModal.classList.remove('hidden');
                alertModal.classList.add('flex');
            }

            function hideAlert() {
                alertModal.classList.add('hidden');
                alertModal.classList.remove('flex');
            }

            alertCloseBtn.addEventListener('click', hideAlert);
            // --- End Modal Functions ---

            // --- Updated Data Helpers ---

            function renderBreachCompletionTable() {
                const container = document.getElementById('breach-log-container');
                const items = JSON.parse(localStorage.getItem('breachItems')) || [];
                container.innerHTML = ''; 

                // Filter for items completed TODAY
                const today = new Date().toISOString().split('T')[0];
                const todayItems = items.filter(item => item.completed && item.completedAt && item.completedAt.startsWith(today));

                if (todayItems.length === 0) {
                     container.innerHTML = `<p class="text-center p-4 text-slate-400 text-sm italic">No completed items today.</p>`;
                    return;
                }

                // Sort by time
                todayItems.sort((a,b) => new Date(b.completedAt) - new Date(a.completedAt));

                todayItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "flex items-start gap-3 mb-2 pb-2 border-b border-slate-50 dark:border-slate-700/50 last:border-0";
                    div.innerHTML = `
                        <div class="mt-1 w-2 h-2 rounded-full bg-emerald-400 shrink-0"></div>
                        <span class="text-sm text-slate-600 dark:text-slate-300 line-clamp-1">${item.text}</span>
                    `;
                    container.appendChild(div);
                });
            }

            function renderBreachStats() {
                const breachItems = JSON.parse(localStorage.getItem('breachItems')) || [];
                // Only count today's completed for stats, or total active? 
                // Let's stick to Today's Completed for the Dashboard Widget
                const today = new Date().toISOString().split('T')[0];
                const completedToday = breachItems.filter(item => item.completed && item.completedAt && item.completedAt.startsWith(today)).length;
                
                // Assuming a default target of 20 for the dashboard visualization if not set by hourly
                const dailyTarget = 100; // Arbitrary high target for the bar or read from localStorage

                const els = {
                    total: document.getElementById('breach-stats-total'),
                    completed: document.getElementById('breach-stats-completed'),
                    bar: document.getElementById('breach-stats-progress-bar'),
                    percent: document.getElementById('breach-stats-progress-percent')
                };

                // Update simple stats
                if(els.completed) els.completed.textContent = completedToday;
                if(els.total) els.total.textContent = dailyTarget;
                
                const percentage = Math.min(100, (completedToday / dailyTarget) * 100);
                if(els.bar) els.bar.style.width = `${percentage}%`;
                if(els.percent) els.percent.textContent = `${Math.round(percentage)}%`;
            }

            function renderDailyBreachProgress() {
                // This function seems redundant with renderBreachStats but kept for safety if used elsewhere
                renderBreachStats();
            }

            function setupSoundscapes() {
                const soundGenerator = new NoiseGenerator();
                const btns = document.querySelectorAll('.sound-btn');
                const volumeSlider = document.getElementById('sound-volume');
                const indicator = document.getElementById('sound-status-indicator');

                btns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const type = btn.dataset.type;
                        const isNowPlaying = soundGenerator.toggle(type);
                        
                        btns.forEach(b => {
                            b.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-600', 'text-white', 'shadow-lg');
                            b.classList.add('text-slate-400');
                        });

                        if (isNowPlaying) {
                            btn.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-600', 'text-white', 'shadow-lg');
                            btn.classList.remove('text-slate-400');
                            indicator.classList.remove('bg-slate-600');
                            indicator.classList.add('bg-green-500', 'shadow-[0_0_10px_rgba(34,197,94,0.6)]');
                        } else {
                            indicator.classList.add('bg-slate-600');
                            indicator.classList.remove('bg-green-500', 'shadow-[0_0_10px_rgba(34,197,94,0.6)]');
                        }
                    });
                });

                volumeSlider.addEventListener('input', (e) => {
                    soundGenerator.setVolume(parseFloat(e.target.value));
                });
            }

            function initializeDashboard() {
                if (dashboardInitialized) return;

                grid.innerHTML = ''; 

                curriculumData.forEach((moduleData) => {
                    const moduleCard = document.createElement('div');
                    moduleCard.className = `module-card bg-white dark:bg-gray-800 rounded-[2rem] shadow-sm border border-slate-100 dark:border-slate-700 p-8 flex flex-col group hover:shadow-lg transition-all duration-300 hover:-translate-y-1`;
                    moduleCard.dataset.module = moduleData.module;
                    
                    moduleCard.innerHTML = `
                        <div class="flex-grow">
                            <div class="w-14 h-14 rounded-2xl bg-${moduleData.themeColor}-100 dark:bg-${moduleData.themeColor}-900/30 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300">
                                <svg class="w-7 h-7 text-${moduleData.themeColor}-600 dark:text-${moduleData.themeColor}-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${moduleData.icon}</svg>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-3 tracking-tight">${moduleData.module}</h3>
                            <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-6 h-24 overflow-hidden">${moduleData.description}</p>
                        </div>
                        <div class="mt-auto">
                            <button class="learn-more-btn w-full py-3 bg-slate-50 dark:bg-slate-700/50 text-slate-700 dark:text-slate-200 font-bold rounded-xl hover:bg-indigo-600 hover:text-white transition-all focus:outline-none focus:ring-4 focus:ring-indigo-500/20"
                                data-module="${moduleData.module}"
                                data-description="${moduleData.description}"
                                data-topics='${JSON.stringify(moduleData.topics)}'>
                                Learn More
                            </button>
                        </div>
                    `;
                    grid.appendChild(moduleCard);
                });

                renderBreachCompletionTable(); 
                renderBreachStats();
                setupDailyQuote();
                setupTimeAndWeather();
                setupNavigation();
                setupPrincipleModals();
                setupPomodoro();
                setupMindfulness();
                setupShiftTimer();
                setupHourCalculator();
                setupIdeaBoard();
                setupSettings();
                setupBreachList();
                setupSalaryCalculator();
                setupOvertimeTracker();
                setupBallGame(); 
                setupSoundscapes();
                dashboardInitialized = true;
            }
            
            getStartedBtn.addEventListener('click', () => {
                initializeDashboard();
                landingPage.style.display = 'none';
                appLayout.classList.remove('hidden-fade');
                appLayout.classList.add('visible-fade');
                localStorage.setItem('appEntered', 'true');
                navigateToView('dashboard-home');
            });

            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('appEntered');
                localStorage.removeItem('lastActiveView');
                appLayout.style.opacity = 0;
                setTimeout(() => {
                    appLayout.classList.add('hidden-fade');
                    appLayout.classList.remove('visible-fade');
                    
                    landingPage.style.display = 'flex';
                    setTimeout(() => {
                        landingPage.style.opacity = 1;
                    }, 50);
                }, 500);
            });

            function navigateToView(viewId) {
                const pageViews = document.querySelectorAll('.page-view');
                const sidebarLinks = document.querySelectorAll('.sidebar-link');
                const mainContentWrapper = document.getElementById('main-content-wrapper');

                pageViews.forEach(page => {
                    page.classList.toggle('active', page.id === viewId);
                });

                if (['pomodoro', 'shift-timer', 'idea-board', 'mindfulness', 'ball-game'].includes(viewId)) {
                    mainContentWrapper.classList.remove('container', 'mx-auto', 'px-4', 'sm:px-6', 'py-8');
                } else {
                    mainContentWrapper.classList.add('container', 'mx-auto', 'px-4', 'sm:px-6', 'py-8');
                }

                sidebarLinks.forEach(link => {
                    link.classList.toggle('active', link.dataset.view === viewId);
                });

                localStorage.setItem('lastActiveView', viewId);
            }
            
            function setupNavigation() {
                const navLinks = document.querySelectorAll('.nav-link');
                const topicsToggleBtn = document.getElementById('topics-toggle-btn');
                const topicsSubmenu = document.getElementById('topics-submenu');
                const toolsToggleBtn = document.getElementById('tools-toggle-btn');
                const toolsSubmenu = document.getElementById('tools-submenu');
                const topicsArrow = document.getElementById('topics-arrow');
                const toolsArrow = document.getElementById('tools-arrow');
                const topicFilters = document.querySelectorAll('.topic-filter');

                openSidebarBtn.addEventListener('click', () => sidebar.classList.remove('-translate-x-full'));
                closeSidebarBtn.addEventListener('click', () => sidebar.classList.add('-translate-x-full'));

                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateToView(link.dataset.view);
                        if (window.innerWidth < 1024) {
                           sidebar.classList.add('-translate-x-full');
                        }
                    });
                });

                topicsToggleBtn.addEventListener('click', () => {
                    if (topicsSubmenu.style.maxHeight) {
                        topicsSubmenu.style.maxHeight = null;
                        topicsArrow.classList.remove('rotate-180');
                    } else {
                        topicsSubmenu.style.maxHeight = topicsSubmenu.scrollHeight + "px";
                        topicsArrow.classList.add('rotate-180');
                    }
                });
                
                toolsToggleBtn.addEventListener('click', () => {
                    if (toolsSubmenu.style.maxHeight) {
                        toolsSubmenu.style.maxHeight = null;
                        toolsArrow.classList.remove('rotate-180');
                    } else {
                        toolsSubmenu.style.maxHeight = toolsSubmenu.scrollHeight + "px";
                        toolsArrow.classList.add('rotate-180');
                    }
                });

                topicFilters.forEach(filter => {
                    filter.addEventListener('click', (e) => {
                        e.preventDefault();
                        const moduleToShow = filter.dataset.module;
                        navigateToView('dashboard-home');
                        document.querySelectorAll('.module-card').forEach(card => {
                            card.style.display = (moduleToShow === 'all' || card.dataset.module === moduleToShow) ? 'flex' : 'none';
                        });
                        if (window.innerWidth < 1024) {
                           sidebar.classList.add('-translate-x-full');
                        }
                    });
                });
            }

            function setupPrincipleModals() {
                const modal = document.getElementById('principle-modal');
                const modalContent = modal.querySelector('.transform');
                const modalTitle = document.getElementById('principle-modal-title');
                const modalDescription = document.getElementById('principle-modal-description');
                const modalTasks = document.getElementById('principle-modal-tasks');
                const closeBtn = document.getElementById('principle-modal-close-btn');
                const okBtn = document.getElementById('principle-modal-ok-btn');

                function showModal() {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        modalContent.classList.remove('scale-95');
                    }, 10);
                }

                function hideModal() {
                    modal.classList.add('opacity-0');
                    modalContent.classList.add('scale-95');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                    }, 300);
                }

                document.getElementById('curriculum-grid').addEventListener('click', (e) => {
                    const learnMoreBtn = e.target.closest('.learn-more-btn');
                    if (learnMoreBtn) {
                        const title = learnMoreBtn.dataset.module;
                        const description = learnMoreBtn.dataset.description;
                        const topics = JSON.parse(learnMoreBtn.dataset.topics);

                        modalTitle.textContent = title;
                        modalDescription.textContent = description;
                        
                        modalTasks.innerHTML = ''; 
                        let tasksHtml = '';
                        topics.forEach(topic => {
                            tasksHtml += `<h4 class="font-bold text-lg mt-6 mb-3 text-slate-800 dark:text-white flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-indigo-500"></span>${topic.title}</h4>`;
                            tasksHtml += '<ul class="space-y-2 text-slate-600 dark:text-slate-400 text-sm ml-4 border-l-2 border-slate-100 dark:border-slate-700 pl-4">';
                            topic.items.forEach(item => {
                                tasksHtml += `<li>${item}</li>`;
                            });
                            tasksHtml += '</ul>';
                        });
                        modalTasks.innerHTML = tasksHtml;

                        showModal();
                    }
                });

                closeBtn.addEventListener('click', hideModal);
                okBtn.addEventListener('click', hideModal);
                modal.addEventListener('click', (e) => {
                    if(e.target === modal) {
                        hideModal();
                    }
                })
            }
            
            function setupPomodoro() {
                const pomodoroPage = document.getElementById('pomodoro');
                const modes = {
                    pomodoro: { name: 'Focus', time: 25, color: '#6366f1', icon: 'üçÖ', next: 'shortBreak', background: 'https://images.unsplash.com/photo-1484417894907-623942c8ee29?q=80&w=3132&auto=format&fit=crop' },
                    shortBreak: { name: 'Relax', time: 5, color: '#3b82f6', icon: '‚òï', next: 'pomodoro', background: 'https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?q=80&w=2940&auto=format&fit=crop' },
                };
                let timer; let currentMode = 'pomodoro'; let totalSeconds = modes[currentMode].time * 60; let remainingSeconds = totalSeconds; let isPaused = true; let sessionCount = 0;
                const canvas = document.getElementById('pomodoro-canvas'); const ctx = canvas.getContext('2d'); const timeDisplay = document.getElementById('pomodoro-time'); const modeDisplay = document.getElementById('pomodoro-mode'); const iconDisplay = document.getElementById('pomodoro-icon'); const playPauseBtn = document.getElementById('pomodoro-play-pause'); const playIcon = document.getElementById('play-icon'); const pauseIcon = document.getElementById('pause-icon'); const switchModeBtn = document.getElementById('pomodoro-switch-mode'); const sessionCountDisplay = document.getElementById('pomodoro-session-count');
                
                function drawCircle(progress) {
                    const centerX = canvas.width / 2; const centerY = canvas.height / 2; const radius = canvas.width / 2 - 10;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.beginPath(); ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI); ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)'; ctx.lineWidth = 15; ctx.stroke();
                    if (progress > 0) { ctx.beginPath(); ctx.arc(centerX, centerY, radius, -0.5 * Math.PI, (progress * 2 * Math.PI) - 0.5 * Math.PI); ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 15; ctx.lineCap = 'round'; ctx.shadowBlur = 20; ctx.shadowColor = 'rgba(255,255,255,0.5)'; ctx.stroke(); ctx.shadowBlur = 0; }
                }
                function updateDisplay() { const minutes = Math.floor(remainingSeconds / 60); const seconds = remainingSeconds % 60; timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`; const progress = (totalSeconds - remainingSeconds) / totalSeconds; drawCircle(progress); }
                function setMode(modeKey) { currentMode = modeKey; const mode = modes[currentMode]; totalSeconds = mode.time * 60; remainingSeconds = totalSeconds; modeDisplay.textContent = mode.name; iconDisplay.textContent = mode.icon; switchModeBtn.textContent = mode.next === 'pomodoro' ? 'Start Focus' : 'Take a Break'; pomodoroPage.style.backgroundImage = `url('${mode.background}')`; updateDisplay(); }
                function countdown() { if (isPaused) return; if (remainingSeconds > 0) { remainingSeconds--; updateDisplay(); } else { clearInterval(timer); isPaused = true; playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); if (currentMode === 'pomodoro') { sessionCount++; sessionCountDisplay.textContent = sessionCount; } showAlert(`${modes[currentMode].name} session is over!`); setMode(modes[currentMode].next); } }
                playPauseBtn.addEventListener('click', () => { hideAlert(); isPaused = !isPaused; if (!isPaused) { timer = setInterval(countdown, 1000); playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); } else { clearInterval(timer); playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); } });
                switchModeBtn.addEventListener('click', () => { hideAlert(); isPaused = true; clearInterval(timer); playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); setMode(modes[currentMode].next); });
                setMode('pomodoro');
            }

            function setupMindfulness() {
                const tabBreathing = document.getElementById('tab-breathing');
                const tabRefresh = document.getElementById('tab-refresh');
                const viewBreathing = document.getElementById('view-breathing');
                const viewRefresh = document.getElementById('view-refresh');
                const startBtn = document.getElementById('mindfulness-start-btn');
                const durationSelect = document.getElementById('mindfulness-duration');
                const visualizer = document.getElementById('breathing-visualizer');
                const instruction = document.getElementById('breathing-instruction');
                const sessionCountEl = document.getElementById('mindfulness-session-count');
                const startRefreshBtn = document.getElementById('start-refresh-btn');
                const refreshText = document.getElementById('refresh-text');
                const refreshControls = document.getElementById('refresh-controls');
                const refreshCircle = document.getElementById('refresh-circle');

                let sessionTimer, instructionTimer;
                let isBreathing = false;
                
                function switchTab(mode) {
                    if (mode === 'breathing') {
                        tabBreathing.classList.replace('text-white/60', 'text-white');
                        tabBreathing.classList.add('bg-white/20', 'shadow-sm');
                        tabRefresh.classList.replace('text-white', 'text-white/60');
                        tabRefresh.classList.remove('bg-white/20', 'shadow-sm');
                        viewBreathing.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
                        viewRefresh.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
                    } else {
                        tabRefresh.classList.replace('text-white/60', 'text-white');
                        tabRefresh.classList.add('bg-white/20', 'shadow-sm');
                        tabBreathing.classList.replace('text-white', 'text-white/60');
                        tabBreathing.classList.remove('bg-white/20', 'shadow-sm');
                        viewRefresh.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
                        viewBreathing.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
                    }
                }
                
                tabBreathing.addEventListener('click', () => switchTab('breathing'));
                tabRefresh.addEventListener('click', () => switchTab('refresh'));

                const BREATHE_IN = 4000;
                const HOLD = 2000;
                const BREATHE_OUT = 4000;
                const CYCLE_TIME = BREATHE_IN + HOLD + BREATHE_OUT;

                function loadSessionCount() {
                    const count = localStorage.getItem('mindfulnessSessions') || 0;
                    sessionCountEl.textContent = count;
                }

                function updateInstruction() {
                    instruction.style.opacity = 0;
                    setTimeout(() => {
                        instruction.textContent = "Breathe In...";
                        instruction.style.opacity = 1;
                    }, 500);

                    setTimeout(() => {
                        instruction.style.opacity = 0;
                        setTimeout(() => {
                            instruction.textContent = "Hold";
                            instruction.style.opacity = 1;
                        }, 500);
                    }, BREATHE_IN);

                    setTimeout(() => {
                        instruction.style.opacity = 0;
                        setTimeout(() => {
                            instruction.textContent = "Breathe Out...";
                            instruction.style.opacity = 1;
                        }, 500);
                    }, BREATHE_IN + HOLD);
                }

                function startSession() {
                    if (isBreathing) return;
                    isBreathing = true;
                    const duration = parseInt(durationSelect.value) * 1000;
                    startBtn.textContent = 'Session in Progress...';
                    startBtn.disabled = true;
                    durationSelect.disabled = true;
                    visualizer.classList.add('breathing');
                    updateInstruction();
                    instructionTimer = setInterval(updateInstruction, CYCLE_TIME);
                    sessionTimer = setTimeout(() => {
                        endSession(true);
                    }, duration);
                }

                function endSession(completed = false) {
                    isBreathing = false;
                    clearInterval(instructionTimer);
                    clearTimeout(sessionTimer);
                    visualizer.classList.remove('breathing');
                    instruction.textContent = "Ready?";
                    startBtn.textContent = 'Start Session';
                    startBtn.disabled = false;
                    durationSelect.disabled = false;
                    if (completed) {
                        let count = parseInt(localStorage.getItem('mindfulnessSessions') || 0);
                        count++;
                        localStorage.setItem('mindfulnessSessions', count);
                        sessionCountEl.textContent = count;
                        showAlert("Mindfulness session complete. Well done!");
                    }
                }
                
                startBtn.addEventListener('click', startSession);
                loadSessionCount();
                
                const refreshSteps = [
                    { text: "Sit comfortably. Let your hands rest loosely.", duration: 4000 },
                    { text: "Close your eyes, or soften your gaze.", duration: 4000 },
                    { text: "Take a deep breath in...", duration: 3000 },
                    { text: "And exhale slowly. Let it all go.", duration: 4000 },
                    { text: "Drop your shoulders away from your ears.", duration: 4000 },
                    { text: "Unclench your jaw. Relax your face.", duration: 4000 },
                    { text: "Notice the ground beneath your feet.", duration: 4000 },
                    { text: "You are here. You are safe.", duration: 4000 },
                    { text: "Take one last deep breath.", duration: 4000 },
                    { text: "Open your eyes. You are refreshed.", duration: 4000 }
                ];
                let refreshStepIndex = 0;
                let isRefreshing = false;
                
                function runRefreshSequence() {
                    if (refreshStepIndex >= refreshSteps.length) {
                        isRefreshing = false;
                        refreshText.style.opacity = 0;
                        setTimeout(() => {
                            refreshText.textContent = "Welcome back.";
                            refreshText.style.opacity = 1;
                            refreshControls.classList.remove('opacity-0', 'pointer-events-none');
                            refreshCircle.classList.remove('opacity-100');
                        }, 500);
                        return;
                    }
                    const step = refreshSteps[refreshStepIndex];
                    refreshText.style.opacity = 0;
                    setTimeout(() => {
                        refreshText.textContent = step.text;
                        refreshText.style.opacity = 1;
                        setTimeout(() => {
                            refreshStepIndex++;
                            runRefreshSequence();
                        }, step.duration);
                    }, 500);
                }
                
                startRefreshBtn.addEventListener('click', () => {
                    if (isRefreshing) return;
                    isRefreshing = true;
                    refreshStepIndex = 0;
                    refreshControls.classList.add('opacity-0', 'pointer-events-none');
                    refreshCircle.classList.add('opacity-100');
                    runRefreshSequence();
                });
            }

            function setupTimeAndWeather() {
                const timeEl = document.getElementById('time-display'); const dateEl = document.getElementById('date-display'); const weatherEl = document.getElementById('weather-display');
                function updateTime() { const now = new Date(); timeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); dateEl.textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
                
                async function fetchWeatherData(lat, lon, locationLabel) {
                    try { 
                        // Start both requests in parallel
                        const weatherPromise = fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                        
                        // Attempt to get city name if we are using local coordinates
                        let displayLabel = locationLabel;
                        if (locationLabel === "Local Weather") {
                            try {
                                const cityResponse = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                                const cityData = await cityResponse.json();
                                if (cityData.city) displayLabel = cityData.city;
                                else if (cityData.locality) displayLabel = cityData.locality;
                            } catch (e) {
                                console.warn("City lookup failed, keeping default label");
                            }
                        }

                        const response = await weatherPromise;
                        if (!response.ok) throw new Error('Weather fetch failed'); 
                        const data = await response.json(); 
                        const weather = data.current_weather; 
                        weatherEl.innerHTML = `<div class="text-4xl filter drop-shadow-md">${getWeatherIcon(weather.weathercode)}</div><div class="text-right"><p class="font-bold text-2xl">${Math.round(weather.temperature)}¬∞C</p><p class="text-xs font-bold uppercase tracking-wider text-white/70">${displayLabel}</p></div>`; 
                    } catch (error) { 
                        weatherEl.innerHTML = `<div class="text-4xl">‚õÖ</div><div><p class="font-bold text-xl">--¬∞C</p><p class="text-xs text-white/60">Offline</p></div>`; 
                    }
                }

                function fetchWeather() { 
                    if (navigator.geolocation) {
                        // Show loading state
                        weatherEl.innerHTML = `<div class="animate-pulse flex gap-2 items-center"><div class="h-8 w-8 bg-white/20 rounded-full"></div><div class="h-4 w-16 bg-white/20 rounded"></div></div>`;
                        
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                fetchWeatherData(position.coords.latitude, position.coords.longitude, "Local Weather");
                            },
                            (error) => {
                                console.warn("Geolocation denied or error, using fallback.");
                                fetchWeatherData(53.4084, -2.9916, "Liverpool, UK");
                            },
                            { timeout: 10000, maximumAge: 60000 }
                        );
                    } else {
                        fetchWeatherData(53.4084, -2.9916, "Liverpool, UK");
                    }
                }

                function getWeatherIcon(code) { if (code === 0) return '‚òÄÔ∏è'; if ([1, 2, 3].includes(code)) return '‚òÅÔ∏è'; if ([45, 48].includes(code)) return 'üå´Ô∏è'; if (code >= 51 && code <= 57) return 'üíß'; if (code >= 61 && code <= 67) return 'üåßÔ∏è'; if (code >= 71 && code <= 77) return '‚ùÑÔ∏è'; if (code >= 80 && code <= 82) return 'üå¶Ô∏è'; if (code >= 95 && code <= 99) return '‚õàÔ∏è'; return 'üåç'; }
                updateTime(); setInterval(updateTime, 1000); fetchWeather(); setInterval(fetchWeather, 900000); 
            }

            function setupBreachList() {
                // UI References
                const elements = {
                    currentHourLabel: document.getElementById('breach-current-hour-label'),
                    hourlyCount: document.getElementById('breach-hourly-count'),
                    progressCircle: document.getElementById('breach-hourly-progress-circle'),
                    targetDisplay: document.getElementById('breach-hourly-target-display'),
                    paceStatus: document.getElementById('breach-pace-status'),
                    todayTotal: document.getElementById('breach-today-total'),
                    efficiency: document.getElementById('breach-efficiency'),
                    input: document.getElementById('breach-item-input'),
                    addBtn: document.getElementById('add-breach-item-btn'),
                    syncBtn: document.getElementById('sync-breach-target-btn'),
                    listContainer: document.getElementById('breach-list-uncompleted-container'),
                    historyContainer: document.getElementById('breach-history-container'),
                    viewCurrent: document.getElementById('view-breach-current'),
                    viewHistory: document.getElementById('view-breach-history'),
                    tabCurrent: document.getElementById('tab-breach-current'),
                    tabHistory: document.getElementById('tab-breach-history')
                };

                // State
                let breachItems = JSON.parse(localStorage.getItem('breachItems')) || [];
                let hourlyTargets = JSON.parse(localStorage.getItem('breachHourlyTargets')) || {}; // Key: "YYYY-MM-DD-HH", Value: Number
                
                // Constants
                const CIRCLE_CIRCUMFERENCE = 440;
                const BASE_RATE_PER_HOUR = 10;

                // --- Helper Functions ---

                function getCurrentHourKey() {
                    const now = new Date();
                    return `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}-${now.getHours()}`;
                }

                function getCurrentHourLabel() {
                    const now = new Date();
                    const start = now.getHours();
                    const end = (start + 1) % 24;
                    return `${start.toString().padStart(2, '0')}:00 - ${end.toString().padStart(2, '0')}:00`;
                }

                function calculateDynamicTarget() {
                    const now = new Date();
                    const minutesRemaining = 60 - now.getMinutes();
                    // Calculate proportional target based on 10 per hour
                    // E.g., 30 mins left = 5 breaches. Always round up to be ambitious, or ceil.
                    let target = Math.ceil((minutesRemaining / 60) * BASE_RATE_PER_HOUR);
                    // Ensure at least 1 if there's any time left, unless 0 mins
                    if (target < 1 && minutesRemaining > 5) target = 1;
                    
                    return target;
                }

                function setHourlyTarget() {
                    const key = getCurrentHourKey();
                    const newTarget = calculateDynamicTarget();
                    
                    // If a target already exists for this hour and it's higher (from a previous sync), maybe keep it?
                    // User requested: "get new target depending on the time it was clicked" -> implying overwrite/update.
                    hourlyTargets[key] = newTarget;
                    localStorage.setItem('breachHourlyTargets', JSON.stringify(hourlyTargets));
                    renderDashboard();
                    showAlert(`Target synced: ${newTarget} breaches for the remaining time.`);
                }

                function getBreachesForHour(hourKey) {
                    // Filter items created in this hour key
                    return breachItems.filter(item => {
                        const d = new Date(item.createdAt);
                        const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}-${d.getHours()}`;
                        return key === hourKey;
                    });
                }

                function updateProgressCircle(count, target) {
                    if (target <= 0) target = 10; // Fallback
                    const percentage = Math.min(1, count / target);
                    const offset = CIRCLE_CIRCUMFERENCE - (percentage * CIRCLE_CIRCUMFERENCE);
                    elements.progressCircle.style.strokeDashoffset = offset;
                    
                    if (count >= target) {
                        elements.progressCircle.classList.remove('text-indigo-500');
                        elements.progressCircle.classList.add('text-emerald-500');
                    } else {
                        elements.progressCircle.classList.add('text-indigo-500');
                        elements.progressCircle.classList.remove('text-emerald-500');
                    }
                }

                function renderDashboard() {
                    const currentKey = getCurrentHourKey();
                    elements.currentHourLabel.textContent = getCurrentHourLabel();
                    
                    // Get Target
                    let target = hourlyTargets[currentKey];
                    if (target === undefined) {
                        target = 10; // Default if not synced
                        elements.targetDisplay.textContent = "10 (Default)";
                    } else {
                        elements.targetDisplay.textContent = target;
                    }

                    // Get Counts
                    const currentHourItems = getBreachesForHour(currentKey);
                    
                    // Usually "Breach per hour" implies completing the breach. 
                    const completedCount = currentHourItems.filter(i => i.completed).length;
                    
                    elements.hourlyCount.textContent = completedCount;
                    updateProgressCircle(completedCount, target);

                    // Pace Status
                    if (target > 0) {
                        if (completedCount >= target) {
                            elements.paceStatus.textContent = "Crushing It! üî•";
                            elements.paceStatus.className = "text-sm font-bold text-emerald-400";
                        } else if (completedCount >= (target * 0.8)) {
                            elements.paceStatus.textContent = "Almost There";
                            elements.paceStatus.className = "text-sm font-bold text-yellow-400";
                        } else {
                            elements.paceStatus.textContent = "Catch Up Needed";
                            elements.paceStatus.className = "text-sm font-bold text-rose-400";
                        }
                    }

                    // Total Stats
                    const todayKey = new Date().toISOString().split('T')[0];
                    const todayItems = breachItems.filter(i => i.createdAt.startsWith(todayKey) && i.completed);
                    elements.todayTotal.textContent = todayItems.length;
                    
                    // Efficiency (Completed / Total Created today)
                    const totalTodayCreated = breachItems.filter(i => i.createdAt.startsWith(todayKey)).length;
                    const eff = totalTodayCreated > 0 ? Math.round((todayItems.length / totalTodayCreated) * 100) : 100;
                    elements.efficiency.textContent = `${eff}%`;

                    renderCurrentList(currentHourItems);
                    
                    // Update global widgets
                    renderBreachCompletionTable();
                    renderBreachStats();
                }

                function renderCurrentList(items) {
                    elements.listContainer.innerHTML = '';
                    if (items.length === 0) {
                        elements.listContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400 opacity-50"><div class="text-4xl mb-2">‚ö°</div><p>Start your breach session.</p></div>`;
                        return;
                    }

                    // Sort: Uncompleted first, then newest
                    items.sort((a, b) => {
                        if (a.completed === b.completed) return new Date(b.createdAt) - new Date(a.createdAt);
                        return a.completed ? 1 : -1;
                    });

                    items.forEach(item => {
                        const el = document.createElement('div');
                        el.className = `group flex items-center p-3 rounded-xl transition-all border ${item.completed ? 'bg-slate-50 dark:bg-slate-800/50 border-transparent opacity-75' : 'bg-white dark:bg-gray-700 border-slate-100 dark:border-gray-600 shadow-sm'}`;
                        el.innerHTML = `
                            <button class="toggle-btn w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3 transition-colors ${item.completed ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300 dark:border-slate-500 hover:border-emerald-400'}">
                                ${item.completed ? '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                            </button>
                            <span class="flex-grow font-medium text-sm ${item.completed ? 'text-slate-400 line-through' : 'text-slate-700 dark:text-slate-200'}">${item.text}</span>
                            <span class="text-[10px] text-slate-400 font-mono mr-3">${new Date(item.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                            <button class="delete-btn text-slate-400 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        `;
                        
                        // Event Listeners
                        el.querySelector('.toggle-btn').addEventListener('click', () => toggleItem(item.id));
                        el.querySelector('.delete-btn').addEventListener('click', () => deleteItem(item.id));
                        
                        elements.listContainer.appendChild(el);
                    });
                }

                function renderHistory() {
                    elements.historyContainer.innerHTML = '';
                    
                    // Group by Hour Key
                    const groups = {};
                    breachItems.forEach(item => {
                        const d = new Date(item.createdAt);
                        const key = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}-${d.getHours()}`;
                        if (!groups[key]) groups[key] = [];
                        groups[key].push(item);
                    });

                    // Sort keys descending
                    const keys = Object.keys(groups).sort().reverse();
                    
                    keys.forEach(key => {
                        if (key === getCurrentHourKey()) return; // Skip current hour in history view (optional)

                        const items = groups[key];
                        const completed = items.filter(i => i.completed).length;
                        const dateObj = new Date(items[0].createdAt); // Use first item for date ref
                        const timeLabel = `${dateObj.getHours().toString().padStart(2,'0')}:00 - ${(dateObj.getHours()+1).toString().padStart(2,'0')}:00`;
                        const dateLabel = dateObj.toLocaleDateString();

                        const card = document.createElement('div');
                        card.className = "bg-slate-50 dark:bg-gray-700/30 rounded-2xl p-4 border border-slate-100 dark:border-gray-700";
                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <div>
                                    <h4 class="font-bold text-slate-700 dark:text-slate-200">${timeLabel}</h4>
                                    <p class="text-xs text-slate-500">${dateLabel}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xl font-bold text-indigo-500">${completed}</span>
                                    <span class="text-xs text-slate-500 uppercase">Done</span>
                                </div>
                            </div>
                            <div class="h-1.5 w-full bg-slate-200 dark:bg-gray-600 rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-500" style="width: ${(completed/Math.max(items.length, 1))*100}%"></div>
                            </div>
                        `;
                        elements.historyContainer.appendChild(card);
                    });
                }

                // --- Actions ---

                function addItem() {
                    const text = elements.input.value.trim();
                    if (!text) return;
                    
                    const newItem = {
                        id: Date.now(),
                        text: text,
                        completed: false, // Default uncompleted
                        createdAt: new Date().toISOString()
                    };
                    
                    breachItems.push(newItem);
                    localStorage.setItem('breachItems', JSON.stringify(breachItems));
                    elements.input.value = '';
                    renderDashboard();
                }

                function toggleItem(id) {
                    const item = breachItems.find(i => i.id === id);
                    if (item) {
                        item.completed = !item.completed;
                        if (item.completed) item.completedAt = new Date().toISOString();
                        else delete item.completedAt;
                        localStorage.setItem('breachItems', JSON.stringify(breachItems));
                        renderDashboard();
                    }
                }

                function deleteItem(id) {
                    breachItems = breachItems.filter(i => i.id !== id);
                    localStorage.setItem('breachItems', JSON.stringify(breachItems));
                    renderDashboard();
                }

                // --- Event Listeners ---
                
                elements.syncBtn.addEventListener('click', setHourlyTarget);
                
                elements.addBtn.addEventListener('click', addItem);
                elements.input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') addItem();
                });

                // Tabs
                elements.tabCurrent.addEventListener('click', () => {
                    elements.viewCurrent.classList.remove('hidden');
                    elements.viewHistory.classList.add('hidden');
                    elements.tabCurrent.classList.add('text-indigo-600', 'dark:text-indigo-400', 'border-b-2', 'border-indigo-600');
                    elements.tabCurrent.classList.remove('text-slate-500', 'dark:text-slate-400');
                    elements.tabHistory.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'border-b-2', 'border-indigo-600');
                    elements.tabHistory.classList.add('text-slate-500', 'dark:text-slate-400');
                });

                elements.tabHistory.addEventListener('click', () => {
                    elements.viewHistory.classList.remove('hidden');
                    elements.viewCurrent.classList.add('hidden');
                    elements.tabHistory.classList.add('text-indigo-600', 'dark:text-indigo-400', 'border-b-2', 'border-indigo-600');
                    elements.tabHistory.classList.remove('text-slate-500', 'dark:text-slate-400');
                    elements.tabCurrent.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'border-b-2', 'border-indigo-600');
                    elements.tabCurrent.classList.add('text-slate-500', 'dark:text-slate-400');
                    renderHistory();
                });

                // Initial Render
                renderDashboard();
                
                // Refresh dashboard every minute to keep time label accurate
                setInterval(renderDashboard, 60000);
            }

            function setupSalaryCalculator() {
                const calculateBtn = document.getElementById('calculate-salary-btn'); const grossInput = document.getElementById('gross-income'); const taxInput = document.getElementById('tax-code'); const resultsDiv = document.getElementById('salary-results'); const breakdownContainer = document.getElementById('salary-breakdown-container');
                const formatCurrency = (val) => `¬£${val.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
                
                calculateBtn.addEventListener('click', () => {
                    const gross = parseFloat(grossInput.value); const taxCode = taxInput.value.toUpperCase(); const type = document.querySelector('input[name="income-type"]:checked').value;
                    if(isNaN(gross) || gross <= 0) { showAlert("Please enter valid income"); return; }
                    const annualGross = type === 'monthly' ? gross * 12 : gross;
                    let allowance = 0; const match = taxCode.match(/(\d+)/); if(match) allowance = parseInt(match[1])*10;
                    if(annualGross > 100000) allowance = Math.max(0, allowance - Math.floor((annualGross-100000)/2));
                    
                    const taxable = Math.max(0, annualGross - allowance);
                    let tax = 0; 
                    if(taxable > 0) {
                        const basic = Math.min(taxable, 37700); tax += basic * 0.2;
                        if(taxable > 37700) { const higher = Math.min(taxable-37700, 125140-allowance-37700); tax += higher * 0.4; }
                        if(taxable > 125140-allowance) { const add = taxable - (125140-allowance); tax += add * 0.45; }
                    }
                    
                    let ni = 0; 
                    if(annualGross > 12570) {
                        const band1 = Math.min(annualGross, 50270) - 12570; ni += Math.max(0, band1) * 0.08;
                        if(annualGross > 50270) { ni += (annualGross - 50270) * 0.02; }
                    }
                    
                    const net = annualGross - tax - ni;
                    document.getElementById('annual-net').textContent = formatCurrency(net);
                    document.getElementById('monthly-net').textContent = formatCurrency(net/12);
                    
                    // Generate nice tables
                    const createRow = (label, val, isDed=false) => `<div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700 last:border-0"><span class="text-slate-500 dark:text-slate-400">${label}</span><span class="font-mono font-bold ${isDed ? 'text-rose-500' : 'text-slate-800 dark:text-slate-200'}">${isDed ? '-' : ''}${formatCurrency(val)}</span></div>`;
                    
                    breakdownContainer.innerHTML = `
                        <div class="space-y-1">
                            <h4 class="font-bold text-center mb-4 text-indigo-600">Annual</h4>
                            ${createRow('Gross Income', annualGross)}
                            ${createRow('Taxable', taxable)}
                            ${createRow('Tax', tax, true)}
                            ${createRow('National Insurance', ni, true)}
                            <div class="flex justify-between py-3 mt-2 border-t-2 border-slate-100 dark:border-slate-600"><span class="font-bold">Net Pay</span><span class="font-mono font-bold text-emerald-600 text-lg">${formatCurrency(net)}</span></div>
                        </div>
                        <div class="space-y-1">
                            <h4 class="font-bold text-center mb-4 text-indigo-600">Monthly</h4>
                            ${createRow('Gross Income', annualGross/12)}
                            ${createRow('Taxable', taxable/12)}
                            ${createRow('Tax', tax/12, true)}
                            ${createRow('National Insurance', ni/12, true)}
                            <div class="flex justify-between py-3 mt-2 border-t-2 border-slate-100 dark:border-slate-600"><span class="font-bold">Net Pay</span><span class="font-mono font-bold text-emerald-600 text-lg">${formatCurrency(net/12)}</span></div>
                        </div>
                    `;
                    resultsDiv.classList.remove('hidden');
                });
            }

            function setupSettings() {
                const themeToggleBtn = document.getElementById('theme-toggle');
                const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
                const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
                if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    themeToggleLightIcon.classList.remove('hidden');
                } else {
                    themeToggleDarkIcon.classList.remove('hidden');
                }
                themeToggleBtn.addEventListener('click', function() {
                    themeToggleDarkIcon.classList.toggle('hidden');
                    themeToggleLightIcon.classList.toggle('hidden');
                    if (localStorage.getItem('color-theme')) {
                        if (localStorage.getItem('color-theme') === 'light') {
                            document.documentElement.classList.add('dark');
                            localStorage.setItem('color-theme', 'dark');
                        } else {
                            document.documentElement.classList.remove('dark');
                            localStorage.setItem('color-theme', 'light');
                        }
                    } else {
                        if (document.documentElement.classList.contains('dark')) {
                            document.documentElement.classList.remove('dark');
                            localStorage.setItem('color-theme', 'light');
                        } else {
                            document.documentElement.classList.add('dark');
                            localStorage.setItem('color-theme', 'dark');
                        }
                    }
                });
            }

            function setupDailyQuote() {
                const quoteTextEl = document.getElementById('quote-text');
                const quoteAuthorEl = document.getElementById('quote-author');
                const quotes = [
                    { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
                    { text: "The best way to predict the future is to create it.", author: "Peter Drucker" },
                    { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" }
                ];
                function getDailyQuote() {
                    const today = new Date().toISOString().split('T')[0];
                    const storedQuoteData = JSON.parse(localStorage.getItem('dailyQuote'));
                    if (storedQuoteData && storedQuoteData.date === today) {
                        quoteTextEl.textContent = `"${storedQuoteData.quote.text}"`;
                        quoteAuthorEl.textContent = `- ${storedQuoteData.quote.author}`;
                    } else {
                        const randomIndex = Math.floor(Math.random() * quotes.length);
                        const newQuote = quotes[randomIndex];
                        localStorage.setItem('dailyQuote', JSON.stringify({
                            date: today,
                            quote: newQuote
                        }));
                        quoteTextEl.textContent = `"${newQuote.text}"`;
                        quoteAuthorEl.textContent = `- ${newQuote.author}`;
                    }
                }
                getDailyQuote();
            }

            function setupIdeaBoard() {
                const ideaBoard = document.getElementById('idea-board');
                const addNoteBtn = document.getElementById('add-note-btn');
                const ideaBoardContainer = document.getElementById('idea-board-container');
                let notes = JSON.parse(localStorage.getItem('sticky-notes')) || [];
                let activeNote = null;
                let offsetX, offsetY;
                const colors = ['bg-yellow-200', 'bg-green-200', 'bg-pink-200', 'bg-blue-200', 'bg-purple-200'];
                function saveNotes() { localStorage.setItem('sticky-notes', JSON.stringify(notes)); }
                function createNoteElement(note) {
                    const noteEl = document.createElement('div');
                    noteEl.id = note.id;
                    noteEl.className = `sticky-note absolute w-60 h-60 p-4 flex flex-col ${note.color}`;
                    noteEl.style.left = `${note.x}px`;
                    noteEl.style.top = `${note.y}px`;
                    noteEl.innerHTML = `<div class="flex-grow overflow-auto"><textarea class="w-full h-full bg-transparent resize-none focus:outline-none text-gray-800">${note.content}</textarea></div><div class="flex justify-end items-center mt-2 space-x-2"><button class="copy-note-btn text-gray-600 hover:text-black"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button><button class="delete-note-btn text-gray-600 hover:text-red-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
                    ideaBoardContainer.appendChild(noteEl);
                    noteEl.addEventListener('mousedown', (e) => { if (e.target.tagName.toLowerCase() === 'textarea') return; activeNote = noteEl; activeNote.classList.add('dragging'); offsetX = e.clientX - noteEl.offsetLeft; offsetY = e.clientY - noteEl.offsetTop; });
                    const textarea = noteEl.querySelector('textarea');
                    textarea.addEventListener('input', () => { const noteToUpdate = notes.find(n => n.id === note.id); noteToUpdate.content = textarea.value; saveNotes(); });
                    noteEl.querySelector('.delete-note-btn').addEventListener('click', () => { notes = notes.filter(n => n.id !== note.id); saveNotes(); noteEl.remove(); });
                    noteEl.querySelector('.copy-note-btn').addEventListener('click', (e) => { const button = e.currentTarget; const originalIcon = button.innerHTML; const tempInput = document.createElement('textarea'); tempInput.value = textarea.value; document.body.appendChild(tempInput); tempInput.select(); document.execCommand('copy'); document.body.removeChild(tempInput); button.innerHTML = `<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`; setTimeout(() => { button.innerHTML = originalIcon; }, 1500) });
                }
                document.addEventListener('mousemove', (e) => { if (!activeNote) return; activeNote.style.left = `${e.clientX - offsetX}px`; activeNote.style.top = `${e.clientY - offsetY}px`; });
                document.addEventListener('mouseup', () => { if (activeNote) { const noteToUpdate = notes.find(n => n.id === activeNote.id); noteToUpdate.x = activeNote.offsetLeft; noteToUpdate.y = activeNote.offsetTop; saveNotes(); activeNote.classList.remove('dragging'); } activeNote = null; });
                addNoteBtn.addEventListener('click', () => { const newNote = { id: `note-${Date.now()}`, content: '', color: colors[Math.floor(Math.random() * colors.length)], x: Math.random() * (ideaBoard.offsetWidth - 240), y: Math.random() * (ideaBoard.offsetHeight - 240) }; notes.push(newNote); createNoteElement(newNote); saveNotes(); });
                notes.forEach(createNoteElement);
            }

            function setupHourCalculator() {
                const timeEntriesContainer = document.getElementById('time-entries'); const addRowBtn = document.getElementById('add-time-row'); const calculateBtn = document.getElementById('calculate-time-btn'); const clearBtn = document.getElementById('clear-time-btn'); const printBtn = document.getElementById('print-time-btn'); const totalHms = document.getElementById('total-time-hms'); const totalDecimal = document.getElementById('total-time-decimal');
                function createTimeRow() { const row = document.createElement('div'); row.className = 'flex items-center space-x-2'; row.innerHTML = `<input type="number" class="time-input w-16 p-2 border rounded-md text-center dark:bg-gray-700 dark:text-white" placeholder="00" min="0"><span class="font-bold">:</span><input type="number" class="time-input w-16 p-2 border rounded-md text-center dark:bg-gray-700 dark:text-white" placeholder="00" min="0" max="59"><span class="font-bold">:</span><input type="number" class="time-input w-16 p-2 border rounded-md text-center dark:bg-gray-700 dark:text-white" placeholder="00" min="0" max="59">`; timeEntriesContainer.appendChild(row); }
                addRowBtn.addEventListener('click', createTimeRow);
                calculateBtn.addEventListener('click', () => { let totalSeconds = 0; const rows = timeEntriesContainer.querySelectorAll('.flex'); rows.forEach(row => { const inputs = row.querySelectorAll('.time-input'); const hours = parseInt(inputs[0].value) || 0; const minutes = parseInt(inputs[1].value) || 0; const seconds = parseInt(inputs[2].value) || 0; totalSeconds += (hours * 3600) + (minutes * 60) + seconds; }); const totalHours = Math.floor(totalSeconds / 3600); const totalMinutes = Math.floor((totalSeconds % 3600) / 60); const remainingSeconds = totalSeconds % 60; totalHms.textContent = `${totalHours.toString().padStart(2, '0')}:${totalMinutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`; totalDecimal.textContent = (totalSeconds / 3600).toFixed(2); });
                clearBtn.addEventListener('click', () => { timeEntriesContainer.innerHTML = ''; for(let i=0; i<5; i++) createTimeRow(); totalHms.textContent = '00:00:00'; totalDecimal.textContent = '0.00'; });
                printBtn.addEventListener('click', () => { window.print(); });
                for(let i=0; i<5; i++) createTimeRow();
            }

            function setupOvertimeTracker() {
                const addBtn = document.getElementById('add-overtime-btn'); const listContainer = document.getElementById('overtime-list'); const totalsContainer = document.getElementById('overtime-fund-totals'); const allocationSelect = document.getElementById('overtime-allocation'); const customAllocationInput = document.getElementById('overtime-allocation-custom');
                const editModal = document.getElementById('overtime-edit-modal'); const cancelEditBtn = document.getElementById('cancel-edit-overtime-btn'); const saveEditBtn = document.getElementById('save-edit-overtime-btn'); const editAllocationSelect = document.getElementById('edit-overtime-allocation'); const editCustomAllocationInput = document.getElementById('edit-overtime-allocation-custom');
                let overtimeEntries = JSON.parse(localStorage.getItem('overtimeEntries')) || [];
                const formatCurrency = (value) => `¬£${value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
                function saveEntries() { localStorage.setItem('overtimeEntries', JSON.stringify(overtimeEntries)); }
                function updateTotals() { totalsContainer.innerHTML = ''; const totals = overtimeEntries.reduce((acc, entry) => { const allocation = entry.allocation; acc[allocation] = (acc[allocation] || 0) + entry.amount; return acc; }, {}); const fundColors = { 'Holiday': 'blue', 'Savings': 'purple' }; Object.keys(totals).sort().forEach(key => { const color = fundColors[key] || 'gray'; const totalEl = document.createElement('div'); totalEl.className = `bg-${color}-100 dark:bg-${color}-900/50 p-4 rounded-lg text-center`; totalEl.innerHTML = `<p class="text-sm text-${color}-800 dark:text-${color}-300">${key} Fund</p><p class="text-2xl font-bold text-${color}-900 dark:text-${color}-200">${formatCurrency(totals[key])}</p>`; totalsContainer.appendChild(totalEl); }); }
                function renderEntries() { listContainer.innerHTML = ''; const groupedByMonth = overtimeEntries.reduce((acc, entry) => { const month = new Date(entry.date).toLocaleString('default', { month: 'long', year: 'numeric' }); if (!acc[month]) { acc[month] = []; } acc[month].push(entry); return acc; }, {}); const sortedMonths = Object.keys(groupedByMonth).sort((a, b) => new Date(b) - new Date(a)); if (sortedMonths.length === 0) { listContainer.innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400">No overtime logged yet.</p>`; updateTotals(); return; } sortedMonths.forEach(month => { const monthContainer = document.createElement('div'); monthContainer.innerHTML = `<h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-2">${month}</h3>`; const groupedByAllocation = groupedByMonth[month].reduce((acc, entry) => { if (!acc[entry.allocation]) { acc[entry.allocation] = []; } acc[entry.allocation].push(entry); return acc; }, {}); Object.keys(groupedByAllocation).sort().forEach(allocation => { const allocationTotal = groupedByAllocation[allocation].reduce((sum, item) => sum + item.amount, 0); const allocationContainer = document.createElement('div'); allocationContainer.className = 'mb-4'; allocationContainer.innerHTML = `<div class="flex justify-between items-center bg-slate-100 dark:bg-gray-700/60 p-2 rounded-t-lg"><h4 class="font-semibold text-slate-800 dark:text-slate-200">${allocation}</h4><span class="font-bold text-slate-800 dark:text-slate-200">${formatCurrency(allocationTotal)}</span></div>`; const entriesList = document.createElement('div'); entriesList.className = 'border border-t-0 dark:border-gray-700 rounded-b-lg'; groupedByAllocation[allocation].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(entry => { const entryEl = document.createElement('div'); entryEl.className = 'grid grid-cols-4 gap-4 items-center p-3 border-b dark:border-gray-700 last:border-b-0'; entryEl.dataset.id = entry.id; entryEl.innerHTML = `<div class="text-slate-800 dark:text-slate-200">${new Date(entry.date).toLocaleDateString()}</div><div class="text-sm text-slate-600 dark:text-slate-400">${entry.hours} hrs @ ${formatCurrency(entry.rate)}/hr</div><div class="font-semibold text-slate-900 dark:text-white">${formatCurrency(entry.amount)}</div><div class="flex justify-end gap-2"><button class="edit-overtime-btn p-1 text-slate-500 hover:text-indigo-600 dark:hover:text-indigo-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button><button class="delete-overtime-btn p-1 text-slate-500 hover:text-red-600 dark:hover:text-red-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`; entriesList.appendChild(entryEl); }); allocationContainer.appendChild(entriesList); monthContainer.appendChild(allocationContainer); }); listContainer.appendChild(monthContainer); }); updateTotals(); }
                allocationSelect.addEventListener('change', () => { customAllocationInput.classList.toggle('hidden', allocationSelect.value !== 'Other'); }); editAllocationSelect.addEventListener('change', () => { editCustomAllocationInput.classList.toggle('hidden', editAllocationSelect.value !== 'Other'); });
                addBtn.addEventListener('click', () => { const date = document.getElementById('overtime-date').value; const hours = parseFloat(document.getElementById('overtime-hours').value); const rate = parseFloat(document.getElementById('overtime-rate').value); let allocation = allocationSelect.value; if (allocation === 'Other') { allocation = customAllocationInput.value.trim(); if (!allocation) { showAlert("Please enter a name for your custom allocation."); return; } } if (!date || isNaN(hours) || hours <= 0 || isNaN(rate) || rate <= 0) { showAlert("Please enter a valid date, hours, and rate."); return; } const amount = hours * rate; overtimeEntries.push({ id: Date.now(), date, hours, rate, amount, allocation }); saveEntries(); renderEntries(); document.getElementById('overtime-date').value = ''; document.getElementById('overtime-hours').value = ''; document.getElementById('overtime-rate').value = ''; customAllocationInput.value = ''; allocationSelect.value = 'Savings'; customAllocationInput.classList.add('hidden'); });
                listContainer.addEventListener('click', (e) => { const editBtn = e.target.closest('.edit-overtime-btn'); const deleteBtn = e.target.closest('.delete-overtime-btn'); if (editBtn) { const entryEl = editBtn.closest('.grid'); const entryId = parseInt(entryEl.dataset.id); const entry = overtimeEntries.find(item => item.id === entryId); document.getElementById('edit-overtime-id').value = entry.id; document.getElementById('edit-overtime-date').value = entry.date; document.getElementById('edit-overtime-hours').value = entry.hours; document.getElementById('edit-overtime-rate').value = entry.rate; const standardOptions = ["Savings", "Holiday"]; if (standardOptions.includes(entry.allocation)) { editAllocationSelect.value = entry.allocation; editCustomAllocationInput.classList.add('hidden'); editCustomAllocationInput.value = ''; } else { editAllocationSelect.value = 'Other'; editCustomAllocationInput.classList.remove('hidden'); editCustomAllocationInput.value = entry.allocation; } editModal.classList.remove('hidden'); editModal.classList.add('flex'); } if (deleteBtn) { const entryEl = deleteBtn.closest('.grid'); const entryId = parseInt(entryEl.dataset.id); overtimeEntries = overtimeEntries.filter(item => item.id !== entryId); saveEntries(); renderEntries(); } });
                function closeEditModal() { editModal.classList.add('hidden'); editModal.classList.remove('flex'); } cancelEditBtn.addEventListener('click', closeEditModal);
                saveEditBtn.addEventListener('click', () => { const id = parseInt(document.getElementById('edit-overtime-id').value); const date = document.getElementById('edit-overtime-date').value; const hours = parseFloat(document.getElementById('edit-overtime-hours').value); const rate = parseFloat(document.getElementById('edit-overtime-rate').value); let allocation = editAllocationSelect.value; if (allocation === 'Other') { allocation = editCustomAllocationInput.value.trim(); if (!allocation) { showAlert("Please enter a name for your custom allocation."); return; } } if (!date || isNaN(hours) || hours <= 0 || isNaN(rate) || rate <= 0) { showAlert("Please enter valid details."); return; } const amount = hours * rate; const entryIndex = overtimeEntries.findIndex(item => item.id === id); if (entryIndex > -1) { overtimeEntries[entryIndex] = { id, date, hours, rate, amount, allocation }; saveEntries(); renderEntries(); closeEditModal(); } });
                renderEntries();
            }

            function setupBallGame() {
                const canvas = document.getElementById('game-canvas'); const ctx = canvas.getContext('2d'); const startGameBtn = document.getElementById('start-game-btn'); const resetGameBtn = document.getElementById('reset-game-btn'); const scoreDisplay = document.getElementById('game-score'); const livesDisplay = document.getElementById('game-lives'); const highScoreDisplay = document.getElementById('game-high-score');
                let gameInterval; let gameRunning = false; let score = 0; let lives = 3; let highScore = localStorage.getItem('ballGameHighScore') || 0; let ballRadius = 10; let x = canvas.width / 2; let y = canvas.height - 30; let dx = 2; let dy = -2; let paddleHeight = 10; let paddleWidth = 75; let paddleX = (canvas.width - paddleWidth) / 2; let rightPressed = false; let leftPressed = false;
                document.addEventListener("keydown", keyDownHandler, false); document.addEventListener("keyup", keyUpHandler, false); canvas.addEventListener("mousemove", mouseMoveHandler, false);
                function keyDownHandler(e) { if(e.key === "Right" || e.key === "ArrowRight") { rightPressed = true; } else if(e.key === "Left" || e.key === "ArrowLeft") { leftPressed = true; } } function keyUpHandler(e) { if(e.key === "Right" || e.key === "ArrowRight") { rightPressed = false; } else if(e.key === "Left" || e.key === "ArrowLeft") { leftPressed = false; } } function mouseMoveHandler(e) { let relativeX = e.clientX - canvas.offsetLeft; if(relativeX > 0 && relativeX < canvas.width) { paddleX = relativeX - paddleWidth / 2; } }
                function drawBall() { ctx.beginPath(); ctx.arc(x, y, ballRadius, 0, Math.PI * 2); ctx.fillStyle = "#ffcc00"; ctx.fill(); ctx.closePath(); } function drawPaddle() { ctx.beginPath(); ctx.rect(paddleX, canvas.height - paddleHeight, paddleWidth, paddleHeight); ctx.fillStyle = "#8d8dff"; ctx.fill(); ctx.closePath(); }
                function draw() { if (!gameRunning) return; ctx.clearRect(0, 0, canvas.width, canvas.height); drawBall(); drawPaddle(); if(x + dx > canvas.width - ballRadius || x + dx < ballRadius) { dx = -dx; } if(y + dy < ballRadius) { dy = -dy; } else if(y + dy > canvas.height - ballRadius) { if(x > paddleX && x < paddleX + paddleWidth) { dy = -dy; } else { lives--; if(!lives) { endGame(); } else { x = canvas.width / 2; y = canvas.height - 30; dx = 2; dy = -2; paddleX = (canvas.width - paddleWidth) / 2; } } } if(rightPressed && paddleX < canvas.width - paddleWidth) { paddleX += 7; } else if(leftPressed && paddleX > 0) { paddleX -= 7; } x += dx; y += dy; score++; scoreDisplay.textContent = `Score: ${score}`; requestAnimationFrame(draw); }
                function startGame() { if (gameRunning) return; gameRunning = true; score = 0; lives = 3; scoreDisplay.textContent = `Score: ${score}`; livesDisplay.textContent = `Lives: ${lives}`; highScoreDisplay.textContent = `High Score: ${highScore}`; gameInterval = requestAnimationFrame(draw); startGameBtn.textContent = "Pause"; } function pauseGame() { if (!gameRunning) return; gameRunning = false; cancelAnimationFrame(gameInterval); startGameBtn.textContent = "Resume"; } function resetGame() { pauseGame(); x = canvas.width / 2; y = canvas.height - 30; dx = 2; dy = -2; paddleX = (canvas.width - paddleWidth) / 2; score = 0; lives = 3; scoreDisplay.textContent = `Score: ${score}`; livesDisplay.textContent = `Lives: ${lives}`; startGameBtn.textContent = "Start"; drawBall(); drawPaddle(); } function endGame() { pauseGame(); showAlert(`Game Over! Your score was ${score}.`); if (score > highScore) { highScore = score; localStorage.setItem('ballGameHighScore', highScore); highScoreDisplay.textContent = `High Score: ${highScore}`; } resetGame(); }
                startGameBtn.addEventListener('click', () => { if (gameRunning) { pauseGame(); } else { startGame(); } }); resetGameBtn.addEventListener('click', resetGame); drawBall(); drawPaddle();
            }

            function setupShiftTimer() {
                const shiftTimerPage = document.getElementById('shift-timer');
                const setupView = document.getElementById('shift-setup');
                const countdownView = document.getElementById('shift-countdown-display');
                const endView = document.getElementById('shift-end-message');
                const startBtn = document.getElementById('start-shift-btn');
                const resetBtn = document.getElementById('reset-shift-btn');
                const newShiftBtn = document.getElementById('new-shift-btn');
                const startTimeInput = document.getElementById('shift-start-time-input');
                const endTimeInput = document.getElementById('shift-end-time-input');
                const endTimeLabel = document.getElementById('shift-end-time-label');
                const startTimeLabel = document.getElementById('shift-start-time-label');
                const shiftBlocksContainer = document.getElementById('shift-blocks-container');
                const presetNormalBtn = document.getElementById('preset-normal-btn');
                const presetOvertimeBtn = document.getElementById('preset-overtime-btn');
                const shiftTitleInput = document.getElementById('shift-title-input');
                const motivationQuote = document.getElementById('shift-motivation-quote');
                
                // Mode Toggle Elements
                const shiftModeCallBtn = document.getElementById('shift-mode-call');
                const shiftModeBreachBtn = document.getElementById('shift-mode-breach');
                const shiftModeLabel = document.getElementById('shift-mode-label');
                const paceWarning = document.getElementById('breach-pace-warning');
                const paceDisplayVal = document.getElementById('pace-display-val');
                const paceMissedVal = document.getElementById('pace-missed-val');
                
                // State for Breach Tracking
                let currentShiftMode = localStorage.getItem('currentShiftMode') || 'breach'; 
                let accumulatedBreachMs = parseInt(localStorage.getItem('shiftBreachTotalMs')) || 0;
                let lastBreachStart = localStorage.getItem('shiftBreachSessionStart') ? new Date(localStorage.getItem('shiftBreachSessionStart')) : null;

                const shareShiftBtn = document.getElementById('share-shift-btn');
                // QR Elements
                const qrModal = document.getElementById('qr-modal');
                const qrContainer = document.getElementById('qrcode-container');
                const closeQrBtn = document.getElementById('close-qr-btn');
                const copyLinkFallbackBtn = document.getElementById('copy-link-fallback-btn');
                let currentShareUrl = '';

                const addBreakBtn = document.getElementById('add-break-btn');
                const loadMyBreaksBtn = document.getElementById('load-my-breaks-btn');
                const breakTimesContainer = document.getElementById('break-times-container');
                const healthBreaksToggle = document.getElementById('health-breaks-toggle');
                const resetBreachesToggle = document.getElementById('reset-breaches-toggle');
                
                const breakActiveDisplay = document.getElementById('break-active-display');
                const breakTimerLarge = document.getElementById('break-timer-large');
                const breakAlertBanner = document.getElementById('break-alert-banner');
                const nextBreakContainer = document.getElementById('next-break-container');
                const timeToNextBreakEl = document.getElementById('time-to-next-break');
                const nextBreakTimeLabel = document.getElementById('next-break-time-label');

                const guideContainer = document.getElementById('current-hour-guide');
                const guideTitle = document.getElementById('current-hour-title');
                const guideContent = document.getElementById('current-hour-content');
                const guideBadge = document.getElementById('current-hour-badge');
                const guideIcon = document.getElementById('current-hour-icon');
                const guideTheme = document.getElementById('current-hour-theme');
                
                const locHomeBtn = document.getElementById('loc-home-btn');
                const locOfficeBtn = document.getElementById('loc-office-btn');
                let shiftLocation = localStorage.getItem('shiftLocation') || 'home';

                const shiftPlanHome = [
                    { hour: 1, title: "Hour 1 ‚Äî Night Owl Launch", theme: "Evening Initiation", icon: "ü¶â", effect: "constellation", tasks: ["Set warm lighting (amber/red)", "Brew first coffee/tea", "Review night's objectives", "Say goodnight to the day walkers"] },
                    { hour: 2, title: "Hour 2 ‚Äî The Quiet Begins", theme: "Distraction Free", icon: "üåë", effect: "rain", tasks: ["World is quieting down", "Deep work session 1", "Phone on DND", "Enjoy the solitude"] },
                    { hour: 3, title: "Hour 3 ‚Äî Momentum", theme: "Steady Flow", icon: "üåä", effect: "bubbles", tasks: ["Hydrate (Large water)", "Check emails before midnight lull", "Steady pace", "Comfort check (temp/chair)"] },
                    { hour: 4, title: "Hour 4 ‚Äî First Refuel", theme: "Energy Maintenance", icon: "ü•™", effect: "embers", tasks: ["Light snack (protein)", "Stretch legs", "Avoid heavy carbs", "Reset eyes (20-20-20 rule)"] },
                    { hour: 5, title: "Hour 5 ‚Äî Midnight Oil", theme: "Peak Focus", icon: "üïØÔ∏è", effect: "constellation", tasks: ["Zero distractions remain", "Tackle the hardest task", "High-fidelity playlist", "Total immersion"] },
                    { hour: 6, title: "Hour 6 ‚Äî The Crossing", theme: "Midnight Lunch", icon: "üïõ", effect: "snow", tasks: ["Halfway point!", "Eat 'Lunch'", "Step outside if safe/possible", "Mental reset"] },
                    { hour: 7, title: "Hour 7 ‚Äî Ghost Mode", theme: "Silent Runner", icon: "üëª", effect: "rain", tasks: ["World is asleep", "Cyberpunk vibes", "Creative work / Coding", "Stay warm"] },
                    { hour: 8, title: "Hour 8 ‚Äî The Dip Defense", theme: "Alertness Check", icon: "üõ°Ô∏è", effect: "embers", tasks: ["Splash face with cold water", "Stand up / Pacing", "Upbeat music switch", "Fight the drowsiness"] },
                    { hour: 9, title: "Hour 9 ‚Äî Second Wind", theme: "Power Through", icon: "üí®", effect: "constellation", tasks: ["Caffeine cutoff check", "Finish major deliverables", "Keep lights bright", "You're over the hump"] },
                    { hour: 10, title: "Hour 10 ‚Äî Pre-Dawn", theme: "Admin & Prep", icon: "‚òï", effect: "rain", tasks: ["Clear inbox", "Organize files", "Low energy tasks", "Listen to a podcast"] },
                    { hour: 11, title: "Hour 11 ‚Äî Blue Hour", theme: "Sunrise Approach", icon: "üåÖ", effect: "bubbles", tasks: ["Birds start chirping", "Finalize reports", "Plan tomorrow's sleep", "Prepare handover notes"] },
                    { hour: 12, title: "Hour 12 ‚Äî Landing Gear", theme: "Deceleration", icon: "üõ¨", effect: "snow", tasks: ["Sunglasses ready", "Blue light blockers on", "Pack up", "Commute home & Sleep"] }
                ];
                const shiftPlanOffice = [
                    { hour: 1, title: "Hour 1 ‚Äî The Handover", theme: "Shift Change", icon: "ü§ù", effect: "bubbles", tasks: ["Get updates from day crew", "Set up desk ergonomics", "Fill water bottle", "Log in to all systems"] },
                    { hour: 2, title: "Hour 2 ‚Äî Silence Falls", theme: "Empty Building", icon: "üîá", effect: "rain", tasks: ["Day staff gone", "Claim the best chair?", "Enjoy the quiet", "Start core tasks"] },
                    { hour: 3, title: "Hour 3 ‚Äî Ops Mode", theme: "Tactical Focus", icon: "üíª", effect: "constellation", tasks: ["Headphones on", "Monitor dashboards", "Clear backlog", "Efficient processing"] },
                    { hour: 4, title: "Hour 4 ‚Äî Perimeter Check", theme: "Movement", icon: "üö∂", effect: "snow", tasks: ["Walk the floor", "Stretch in the hallway", "Vending machine run", "Check in with night team"] },
                    { hour: 5, title: "Hour 5 ‚Äî Cruising Speed", theme: "Steady State", icon: "üöÑ", effect: "embers", tasks: ["Workflow optimized", "Batch processing", "Update logs", "Stay hydrated"] },
                    { hour: 6, title: "Hour 6 ‚Äî Midnight Lunch", theme: "The Break", icon: "üç±", effect: "bubbles", tasks: ["Eat away from desk", "Socialize with night crew", "Read a book", "Do not talk about work"] },
                    { hour: 7, title: "Hour 7 ‚Äî Graveyard Grit", theme: "Deep Night", icon: "ü™¶", effect: "rain", tasks: ["Last coffee opportunity", "Upbeat playlist", "Keep lights bright", "Focus on detail work"] },
                    { hour: 8, title: "Hour 8 ‚Äî Zombie Defense", theme: "Stay Alert", icon: "üßü", effect: "embers", tasks: ["Walk around the building", "Splash cold water on face", "Talk to a colleague", "Shake off the fatigue"] },
                    { hour: 9, title: "Hour 9 ‚Äî The 3AM Wall", theme: "Resistance", icon: "üß±", effect: "snow", tasks: ["Hydrate aggressively", "Stand while working", "Switch task types", "Don't stare at the clock"] },
                    { hour: 10, title: "Hour 10 ‚Äî Solo Pilot", theme: "Quiet Focus", icon: "‚úàÔ∏è", effect: "constellation", tasks: ["Report writing", "Documentation", "Maintenance tasks", "Prepare for day shift arrival"] },
                    { hour: 11, title: "Hour 11 ‚Äî Early Birds", theme: "World Waking Up", icon: "üê¶", effect: "rain", tasks: ["Cleaners arriving", "Tidy desk area", "Final emails", "Watch the sunrise"] },
                    { hour: 12, title: "Hour 12 ‚Äî Extraction Prep", theme: "Go Home", icon: "üõ¨", effect: "bubbles", tasks: ["Handover notes ready", "Pack bag", "Logout", "Enjoy the daylight"] }
                ];

                let shiftTimer; let shiftStartTime; let shiftEndTime; let totalShiftDuration;
                let activeBreakObjects = []; let wasOnBreak = false;
                let particles = []; let animationFrameId;
                
                // --- Helper Functions ---

                function updateLocButtons() {
                    if (shiftLocation === 'home') {
                        locHomeBtn.className = "px-8 py-3 rounded-xl text-sm font-bold transition-all flex items-center gap-2 bg-teal-500/20 text-teal-300 border border-teal-500/50 shadow-[0_0_15px_rgba(45,212,191,0.15)]";
                        locOfficeBtn.className = "px-8 py-3 rounded-xl text-sm font-bold transition-all flex items-center gap-2 text-gray-400 hover:text-white border border-transparent";
                    } else {
                        locOfficeBtn.className = "px-8 py-3 rounded-xl text-sm font-bold transition-all flex items-center gap-2 bg-indigo-500/20 text-indigo-300 border border-indigo-500/50 shadow-[0_0_15px_rgba(99,102,241,0.15)]";
                        locHomeBtn.className = "px-8 py-3 rounded-xl text-sm font-bold transition-all flex items-center gap-2 text-gray-400 hover:text-white border border-transparent";
                    }
                }

                function checkStoredShift() {
                    const storedStart = localStorage.getItem('shiftStartTime');
                    const storedEnd = localStorage.getItem('shiftEndTime');
                    const storedTitle = localStorage.getItem('shiftTitle');
                    if (storedStart && storedEnd) {
                        const now = new Date();
                        const end = new Date(storedEnd);
                        if (now < end) {
                            shiftStartTime = new Date(storedStart); shiftEndTime = end;
                            if (storedTitle) shiftTitleInput.value = storedTitle;
                            totalShiftDuration = (shiftEndTime - shiftStartTime);
                            calculateActiveBreaks();
                            setupView.classList.add('hidden'); countdownView.classList.remove('hidden');
                            endTimeLabel.textContent = `End: ${shiftEndTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                            startTimeLabel.textContent = `Start: ${shiftStartTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                            generateShiftBlocks();
                            shiftCountdown();
                            shiftTimer = setInterval(shiftCountdown, 1000);
                            startEffect('constellation');
                        } else {
                            localStorage.removeItem('shiftEndTime'); // Expired
                        }
                    } else {
                         // Set default inputs
                        const now = new Date();
                        startTimeInput.value = formatDateTimeForInput(now);
                        const eightHoursLater = new Date(now.getTime() + 8 * 60 * 60 * 1000);
                        endTimeInput.value = formatDateTimeForInput(eightHoursLater);
                    }
                }

                function formatDateTimeForInput(date) {
                    const d = new Date(date);
                    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                    return d.toISOString().slice(0, 16);
                }

                function formatTime(ms) {
                    if (ms < 0) ms = 0;
                    const h = Math.floor(ms / (1000 * 60 * 60));
                    const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((ms % (1000 * 60)) / 1000);
                    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                }

                function formatTimeShort(ms) {
                    const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((ms % (1000 * 60)) / 1000);
                    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                }

                function generateShiftBlocks() {
                    shiftBlocksContainer.innerHTML = '';
                    const totalMinutes = totalShiftDuration / (1000 * 60);
                    
                    // Add Breaks Visuals
                    activeBreakObjects.forEach(b => {
                        const startOffset = new Date(b.start) - shiftStartTime;
                        const duration = new Date(b.end) - new Date(b.start);
                        const leftPercent = (startOffset / totalShiftDuration) * 100;
                        const widthPercent = (duration / totalShiftDuration) * 100;
                        
                        const el = document.createElement('div');
                        el.className = "absolute top-0 bottom-0 bg-emerald-500/30 border-l border-r border-emerald-500/50";
                        el.style.left = `${leftPercent}%`;
                        el.style.width = `${widthPercent}%`;
                        el.title = `${b.type} (${new Date(b.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})})`;
                        shiftBlocksContainer.appendChild(el);
                    });

                    // Add Progress Bar
                    const progressEl = document.createElement('div');
                    progressEl.id = 'shift-progress-bar';
                    progressEl.className = "absolute top-0 bottom-0 left-0 bg-teal-500/20 border-r border-teal-400 shadow-[0_0_10px_rgba(45,212,191,0.3)] transition-all duration-1000";
                    progressEl.style.width = '0%';
                    shiftBlocksContainer.appendChild(progressEl);
                }

                function calculateActiveBreaks() {
                    const storedBreaks = JSON.parse(localStorage.getItem('shiftBreakTimes')) || [];
                    activeBreakObjects = [];
                    const shiftDateStr = shiftStartTime.toDateString();
                    
                    storedBreaks.forEach(b => {
                        // Construct break start time relative to shift start
                        // Logic: Break string is "HH:MM". We need to figure out if it's today or tomorrow based on shift start
                        let breakDate = new Date(`${shiftDateStr} ${b.time}`);
                        // If shift starts at 22:00 and break is 02:00, break is next day
                        if (breakDate < shiftStartTime) {
                             breakDate.setDate(breakDate.getDate() + 1);
                        }
                        // If break is still before start (e.g. shift 10pm, break 9pm), it might be invalid or next day?
                        // Simple check: if break > end time, ignore (or check previous day?)
                        // For simplicity, assume breaks are within the 24h window of shift start
                        if (breakDate > shiftEndTime) {
                             // maybe it belongs to previous day? no.
                        } else if (breakDate < shiftStartTime) {
                             // Break is before shift starts? 
                        }
                        
                        // Check if within shift
                        if (breakDate >= shiftStartTime && breakDate < shiftEndTime) {
                            activeBreakObjects.push({
                                start: breakDate.toISOString(),
                                end: new Date(breakDate.getTime() + b.duration * 60000).toISOString(),
                                type: b.type
                            });
                        }
                    });

                    // Health Breaks
                    if (healthBreaksToggle.checked) {
                        let cursor = new Date(shiftStartTime.getTime() + 60*60000); // Start checking 1 hour in
                        while (cursor < new Date(shiftEndTime.getTime() - 30*60000)) {
                            // Check if any existing break overlaps with cursor +/- 30 mins
                            const conflict = activeBreakObjects.some(b => {
                                const bStart = new Date(b.start);
                                const bEnd = new Date(b.end);
                                return (cursor >= new Date(bStart.getTime() - 30*60000) && cursor <= new Date(bEnd.getTime() + 30*60000));
                            });
                            
                            if (!conflict) {
                                activeBreakObjects.push({
                                    start: cursor.toISOString(),
                                    end: new Date(cursor.getTime() + 5 * 60000).toISOString(),
                                    type: "Movement"
                                });
                            }
                            cursor = new Date(cursor.getTime() + 60*60000);
                        }
                    }
                    activeBreakObjects.sort((a,b) => new Date(a.start) - new Date(b.start));
                }

                function updateShiftDisplay(remainingMs) {
                    if (remainingMs < 0) remainingMs = 0;
                    const hours = Math.floor(remainingMs / (1000 * 60 * 60));
                    const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);

                    document.getElementById('shift-hours-display').textContent = hours.toString().padStart(2, '0');
                    document.getElementById('shift-minutes-display').textContent = minutes.toString().padStart(2, '0');
                    document.getElementById('shift-seconds-display').textContent = seconds.toString().padStart(2, '0');
                    
                    const progress = document.getElementById('shift-progress-bar');
                    if (progress) {
                        const elapsed = totalShiftDuration - remainingMs;
                        const pct = (elapsed / totalShiftDuration) * 100;
                        progress.style.width = `${pct}%`;
                    }
                }

                function updateShiftVisuals() {
                    const elapsedMs = new Date() - shiftStartTime;
                    const currentHourIdx = Math.floor(elapsedMs / (1000 * 60 * 60));
                    const plan = shiftLocation === 'home' ? shiftPlanHome : shiftPlanOffice;
                    
                    // Safe index access
                    const hourData = plan[Math.min(currentHourIdx, plan.length - 1)] || plan[plan.length - 1];

                    if (guideTitle.textContent !== hourData.title) {
                        // New hour theme
                        guideBadge.textContent = "Current Vibe";
                        guideTheme.textContent = `// ${hourData.theme}`;
                        guideTitle.textContent = hourData.title;
                        guideIcon.textContent = hourData.icon;
                        
                        guideContent.innerHTML = '';
                        hourData.tasks.forEach(task => {
                            const p = document.createElement('p');
                            p.className = "flex items-center gap-3";
                            p.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-teal-500"></span>${task}`;
                            guideContent.appendChild(p);
                        });
                        
                        startEffect(hourData.effect || 'constellation');
                    }
                }

                // Shift Mode Logic
                function updateShiftModeUI() {
                    if (currentShiftMode === 'call') {
                        shiftModeCallBtn.className = "px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all bg-blue-500/20 text-blue-300 border border-blue-500/30 shadow-[0_0_10px_rgba(59,130,246,0.2)] flex items-center gap-2";
                        shiftModeBreachBtn.className = "px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all text-slate-400 hover:text-white flex items-center gap-2 border border-transparent";
                        shiftModeLabel.textContent = "Communication Station Active";
                        shiftModeLabel.className = "text-blue-200/50 font-mono text-xs tracking-widest uppercase transition-colors";
                    } else {
                        // Breach Mode
                        shiftModeCallBtn.className = "px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all text-slate-400 hover:text-white flex items-center gap-2 border border-transparent";
                        shiftModeBreachBtn.className = "px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all bg-rose-500/20 text-rose-300 border border-rose-500/30 shadow-[0_0_10px_rgba(244,63,94,0.2)] flex items-center gap-2";
                        shiftModeLabel.textContent = "Task Breach Station Active";
                        shiftModeLabel.className = "text-rose-200/50 font-mono text-xs tracking-widest uppercase transition-colors";
                    }
                }
                
                // Initialize UI on load
                updateShiftModeUI();

                function switchShiftMode(newMode) {
                    if (currentShiftMode === newMode) return;
                    
                    const now = new Date();

                    if (newMode === 'call') {
                        // Switching FROM Breach TO Call
                        // Stop the clock and accumulate time
                        if (lastBreachStart) {
                            const sessionDuration = now - lastBreachStart;
                            accumulatedBreachMs += sessionDuration;
                            localStorage.setItem('shiftBreachTotalMs', accumulatedBreachMs);
                        }
                        lastBreachStart = null;
                        localStorage.removeItem('shiftBreachSessionStart');
                    } else {
                        // Switching FROM Call TO Breach
                        // Start the clock
                        lastBreachStart = now;
                        localStorage.setItem('shiftBreachSessionStart', lastBreachStart.toISOString());
                    }

                    currentShiftMode = newMode;
                    localStorage.setItem('currentShiftMode', currentShiftMode);
                    updateShiftModeUI();
                }

                shiftModeCallBtn.addEventListener('click', () => switchShiftMode('call'));
                shiftModeBreachBtn.addEventListener('click', () => switchShiftMode('breach'));


                function playBreakSound() {
                     // Simple notification sound
                     const ctx = new (window.AudioContext || window.webkitAudioContext)();
                     const osc = ctx.createOscillator();
                     const gain = ctx.createGain();
                     osc.type = 'sine';
                     osc.frequency.setValueAtTime(440, ctx.currentTime);
                     osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1);
                     gain.gain.setValueAtTime(0.1, ctx.currentTime);
                     gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                     osc.connect(gain);
                     gain.connect(ctx.destination);
                     osc.start();
                     osc.stop(ctx.currentTime + 0.5);
                }

                function shiftCountdown() {
                    const now = new Date();
                    if (now >= shiftEndTime) { clearInterval(shiftTimer); updateShiftDisplay(0); updateShiftVisuals(); countdownView.classList.add('hidden'); endView.classList.remove('hidden'); stopEffect(); localStorage.removeItem('shiftEndTime'); return; }
                    const remainingMs = shiftEndTime - now; updateShiftDisplay(remainingMs); updateShiftVisuals();
                    let currentBreak = null; let nextBreak = null;
                    for (const b of activeBreakObjects) {
                        const start = new Date(b.start); const end = new Date(b.end);
                        if (now >= start && now < end) { currentBreak = b; break; }
                        if (now < start && !nextBreak) { nextBreak = b; }
                    }
                    if (currentBreak) {
                        if (!wasOnBreak) { playBreakSound(); wasOnBreak = true; }
                        breakActiveDisplay.classList.remove('hidden'); breakAlertBanner.classList.remove('hidden'); nextBreakContainer.classList.add('opacity-0'); guideContainer.classList.add('opacity-25', 'pointer-events-none', 'blur-sm');
                        paceWarning.classList.add('hidden'); // Hide pace warning on break
                        const breakRemaining = new Date(currentBreak.end) - now; breakTimerLarge.textContent = formatTimeShort(breakRemaining); motivationQuote.textContent = "Recharge Mode On";
                    } else {
                        if (wasOnBreak) { wasOnBreak = false; }
                        breakActiveDisplay.classList.add('hidden'); breakAlertBanner.classList.add('hidden'); nextBreakContainer.classList.remove('opacity-0'); guideContainer.classList.remove('opacity-25', 'pointer-events-none', 'blur-sm');
                        motivationQuote.textContent = shiftTitleInput.value || "Let's get this bread!";
                        if (nextBreak) {
                            const timeToNext = new Date(nextBreak.start) - now; timeToNextBreakEl.textContent = formatTime(timeToNext);
                            const nextBreakTimeStr = new Date(nextBreak.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); nextBreakTimeLabel.textContent = `at ${nextBreakTimeStr} (${nextBreak.type})`;
                        } else { timeToNextBreakEl.textContent = "--:--:--"; nextBreakTimeLabel.textContent = "No more breaks scheduled"; }

                        // Pace Calculation Logic (Updated for Fair Tracking)
                        // Calculate total time spent in breach mode so far
                        let totalBreachTimeMs = accumulatedBreachMs;
                        if (currentShiftMode === 'breach' && lastBreachStart) {
                            totalBreachTimeMs += (now - lastBreachStart);
                        }
                        
                        // Convert to hours for rate calculation
                        const breachHours = totalBreachTimeMs / (1000 * 60 * 60);

                        // Only show warning if we are currently in breach mode OR if we want to see it persistently
                        // Requirement: "target should stop and should only be active when it's toggled to breach"
                        if (currentShiftMode === 'breach') {
                            // Only calculate after ~5 minutes of actual breach time to allow ramp up
                            if (breachHours > 0.08) {
                                const breachItems = JSON.parse(localStorage.getItem('breachItems')) || [];
                                const breachesThisShift = breachItems.filter(i => 
                                    i.completed && 
                                    i.completedAt && 
                                    new Date(i.completedAt) >= shiftStartTime
                                ).length;
                                
                                // Rate based on ACTIVE time, not TOTAL time
                                const currentRate = breachHours > 0 ? (breachesThisShift / breachHours) : 0;
                                const targetRate = 10;
                                
                                // Calculate how many we SHOULD have done in the time we spent in breach mode
                                const expectedBreaches = Math.floor(breachHours * targetRate);
                                const missedCount = Math.max(0, expectedBreaches - breachesThisShift);

                                if (missedCount > 0) {
                                    paceWarning.classList.remove('hidden');
                                    paceDisplayVal.textContent = currentRate.toFixed(1);
                                    if(paceMissedVal) paceMissedVal.textContent = missedCount;
                                } else {
                                    paceWarning.classList.add('hidden');
                                }
                            } else {
                                paceWarning.classList.add('hidden');
                            }
                        } else {
                            paceWarning.classList.add('hidden');
                        }
                    }
                }

                function resetShiftTimer() {
                    clearInterval(shiftTimer); stopEffect(); 
                    localStorage.removeItem('shiftEndTime'); 
                    localStorage.removeItem('shiftStartTime'); 
                    localStorage.removeItem('shiftActiveBreakObjects'); 
                    localStorage.removeItem('shiftTitle');
                    
                    // Reset Breach Tracking
                    localStorage.removeItem('shiftBreachTotalMs');
                    localStorage.removeItem('shiftBreachSessionStart');
                    localStorage.removeItem('currentShiftMode');
                    accumulatedBreachMs = 0;
                    lastBreachStart = null;
                    currentShiftMode = 'breach';
                    updateShiftModeUI();

                    // Reset Inputs to Now to prevent stale start times messing up calc
                    const now = new Date();
                    startTimeInput.value = formatDateTimeForInput(now);
                    const eightHoursLater = new Date(now.getTime() + 8 * 60 * 60 * 1000);
                    endTimeInput.value = formatDateTimeForInput(eightHoursLater);

                    setupView.classList.remove('hidden'); countdownView.classList.add('hidden'); endView.classList.add('hidden'); breakActiveDisplay.classList.add('hidden');
                }
                
                // --- Canvas Animation Logic (Particles) ---
                function initParticles(effectType) {
                    const canvas = document.getElementById('shift-timer-canvas');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    particles = [];
                    
                    const count = window.innerWidth > 768 ? 100 : 50;
                    
                    for(let i=0; i<count; i++) {
                        particles.push({
                            x: Math.random() * canvas.width,
                            y: Math.random() * canvas.height,
                            size: Math.random() * 2 + 1,
                            speedX: (Math.random() - 0.5) * 0.5,
                            speedY: (Math.random() - 0.5) * 0.5,
                            opacity: Math.random() * 0.5 + 0.1,
                            type: effectType
                        });
                    }
                }
                
                function animateParticles() {
                    const canvas = document.getElementById('shift-timer-canvas');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    particles.forEach(p => {
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        
                        // Style based on type
                        if (p.type === 'snow') ctx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`;
                        else if (p.type === 'rain') ctx.fillStyle = `rgba(173, 216, 230, ${p.opacity})`;
                        else if (p.type === 'embers') ctx.fillStyle = `rgba(255, 140, 0, ${p.opacity})`;
                        else if (p.type === 'bubbles') ctx.fillStyle = `rgba(135, 206, 235, ${p.opacity})`;
                        else ctx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`; // constellation default
                        
                        ctx.fill();
                        
                        // Move
                        if (p.type === 'snow' || p.type === 'rain') {
                             p.y += (Math.random() * 1 + 0.5); // Fall down
                             if (p.y > canvas.height) p.y = 0;
                        } else if (p.type === 'bubbles') {
                             p.y -= (Math.random() * 1 + 0.5); // Float up
                             if (p.y < 0) p.y = canvas.height;
                        } else {
                             p.x += p.speedX;
                             p.y += p.speedY;
                             if(p.x < 0 || p.x > canvas.width) p.speedX *= -1;
                             if(p.y < 0 || p.y > canvas.height) p.speedY *= -1;
                        }
                    });
                    
                    // Constellation lines
                    if (particles.length > 0 && particles[0].type === 'constellation') {
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
                        ctx.lineWidth = 0.5;
                        for(let i=0; i<particles.length; i++) {
                            for(let j=i+1; j<particles.length; j++) {
                                const dx = particles[i].x - particles[j].x;
                                const dy = particles[i].y - particles[j].y;
                                const dist = Math.sqrt(dx*dx + dy*dy);
                                if (dist < 100) {
                                    ctx.beginPath();
                                    ctx.moveTo(particles[i].x, particles[i].y);
                                    ctx.lineTo(particles[j].x, particles[j].y);
                                    ctx.stroke();
                                }
                            }
                        }
                    }
                    
                    animationFrameId = requestAnimationFrame(animateParticles);
                }
                
                function startEffect(type) {
                    cancelAnimationFrame(animationFrameId);
                    initParticles(type);
                    animateParticles();
                }
                
                function stopEffect() {
                    cancelAnimationFrame(animationFrameId);
                }

                function resizeCanvas() { 
                    const c = document.getElementById('shift-timer-canvas');
                    if(c) { c.width = window.innerWidth; c.height = window.innerHeight; initParticles(particles.length > 0 ? particles[0].type : 'constellation'); }
                }
                window.addEventListener('resize', resizeCanvas);

                // --- Event Listeners & Init ---

                locHomeBtn.addEventListener('click', () => { shiftLocation = 'home'; localStorage.setItem('shiftLocation', 'home'); updateLocButtons(); });
                locOfficeBtn.addEventListener('click', () => { shiftLocation = 'office'; localStorage.setItem('shiftLocation', 'office'); updateLocButtons(); });
                updateLocButtons();

                // Break Management Logic
                let setupBreakList = JSON.parse(localStorage.getItem('shiftBreakTimes')) || [];
                function renderSetupBreaks() {
                    breakTimesContainer.innerHTML = '';
                    setupBreakList.forEach((b, idx) => {
                        const div = document.createElement('div');
                        div.className = "flex justify-between items-center bg-white/10 p-2 rounded-lg border border-white/5";
                        div.innerHTML = `<span class="font-mono text-sm font-bold text-gray-300">${b.time}</span><span class="text-xs text-gray-400 uppercase tracking-wider">${b.duration}m - ${b.type}</span><button class="text-red-400 hover:text-red-300 px-2" data-idx="${idx}">√ó</button>`;
                        breakTimesContainer.appendChild(div);
                    });
                    localStorage.setItem('shiftBreakTimes', JSON.stringify(setupBreakList));
                    // Bind delete buttons
                    breakTimesContainer.querySelectorAll('button').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const idx = parseInt(e.target.dataset.idx);
                            setupBreakList.splice(idx, 1);
                            renderSetupBreaks();
                        });
                    });
                }
                
                addBreakBtn.addEventListener('click', () => {
                    const time = prompt("Enter break start time (HH:MM, 24h format):", "02:00");
                    if (!time) return;
                    const duration = prompt("Enter duration in minutes:", "30");
                    if (!duration) return;
                    setupBreakList.push({ time, duration: parseInt(duration), type: "Break" });
                    setupBreakList.sort((a,b) => a.time.localeCompare(b.time));
                    renderSetupBreaks();
                });
                
                loadMyBreaksBtn.addEventListener('click', () => {
                    setupBreakList = [
                        { time: "22:00", duration: 15, type: "Short Break" },
                        { time: "02:00", duration: 30, type: "Lunch" },
                        { time: "05:00", duration: 15, type: "Short Break" }
                    ];
                    renderSetupBreaks();
                });

                startBtn.addEventListener('click', () => {
                    const startTimeValue = startTimeInput.value; const endTimeValue = endTimeInput.value;
                    if (!startTimeValue || !endTimeValue) { showAlert("Please select both a start and end date and time."); return; }
                    shiftStartTime = new Date(startTimeValue); shiftEndTime = new Date(endTimeValue);
                    if (shiftStartTime >= shiftEndTime) { showAlert("Start time must be before end time."); return; }
                    if (shiftEndTime <= new Date()) { showAlert("The selected shift end time is in the past."); return; }
                    localStorage.setItem('shiftStartTime', shiftStartTime.toISOString()); localStorage.setItem('shiftEndTime', shiftEndTime.toISOString()); localStorage.setItem('shiftTitle', shiftTitleInput.value);
                    
                    // Reset Breaches if requested
                    if (resetBreachesToggle && resetBreachesToggle.checked) {
                        const breachItems = JSON.parse(localStorage.getItem('breachItems')) || [];
                        let hasChanges = false;
                        breachItems.forEach(item => {
                            if (item.completed) {
                                item.completed = false;
                                delete item.completedAt; // Clear timestamp so it doesn't count towards history if unchecked
                                hasChanges = true;
                            }
                        });
                        if (hasChanges) {
                            localStorage.setItem('breachItems', JSON.stringify(breachItems));
                            // Refresh lists if they are initialized
                            const uncompletedContainer = document.getElementById('breach-list-uncompleted-container');
                            if (uncompletedContainer) {
                                // Trigger a re-render of the list if we can access the render function scope
                                // Since renderList is scoped inside setupBreachList, we can't call it directly here easily
                                // but we can reload the page or rely on the user visiting the tab later.
                                // For immediate feedback, we rely on the Pace Calculation logic which reads from localStorage.
                            }
                        }
                    }

                    // Initialize Breach Tracking
                    accumulatedBreachMs = 0;
                    localStorage.setItem('shiftBreachTotalMs', '0');
                    currentShiftMode = 'breach'; // Default start in breach
                    localStorage.setItem('currentShiftMode', 'breach');
                    lastBreachStart = new Date(); // Start the timer immediately
                    localStorage.setItem('shiftBreachSessionStart', lastBreachStart.toISOString());
                    updateShiftModeUI();

                    totalShiftDuration = (shiftEndTime - shiftStartTime); calculateActiveBreaks();
                    setupView.classList.add('hidden'); countdownView.classList.remove('hidden');
                    endTimeLabel.textContent = `End: ${shiftEndTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`; startTimeLabel.textContent = `Start: ${shiftStartTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                    generateShiftBlocks(); shiftCountdown(); shiftTimer = setInterval(shiftCountdown, 1000); startEffect('constellation');
                });

                resetBtn.addEventListener('click', resetShiftTimer); newShiftBtn.addEventListener('click', resetShiftTimer);
                
                // Share QR Code
                shareShiftBtn.addEventListener('click', () => {
                    currentShareUrl = window.location.href; // In a real app this would be a deep link
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, {
                        text: currentShareUrl,
                        width: 128,
                        height: 128,
                        colorDark : "#0f172a",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                    qrModal.classList.remove('hidden');
                    qrModal.classList.add('flex');
                });
                
                closeQrBtn.addEventListener('click', () => {
                    qrModal.classList.add('hidden');
                    qrModal.classList.remove('flex');
                });
                
                copyLinkFallbackBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(currentShareUrl).then(() => {
                        copyLinkFallbackBtn.textContent = 'Copied!';
                        setTimeout(() => copyLinkFallbackBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg> Copy Link`, 2000);
                    });
                });

                checkStoredShift();
                renderSetupBreaks();
            } // end setupShiftTimer
        }); // end DOMContentLoaded
    </script>
</body>
</html>
